(()=>{const createElement=(e,t={},...n)=>{const a=document.createElement(e);for(let[e,n]of Object.entries(t))"class"===e?a.className=n:"style"===e?Object.assign(a.style,n):e.startsWith("on")&&"function"==typeof n?a.addEventListener(e.slice(2).toLowerCase(),n):"checked"===e?a.checked=n:a.setAttribute(e,n);return n.forEach((e=>{"string"==typeof e?a.appendChild(document.createTextNode(e)):e&&a.appendChild(e)})),a},channelCategories=[{name:"General",channels:[{id:"notes1",name:"Notes",type:"notes"}]},{name:"Learning",channels:[{id:"flashcard1",name:"Flashcards",type:"flashcard"},{id:"whiteboard1",name:"Whiteboard",type:"whiteboard"}]},{name:"Utilities",channels:[{id:"code1",name:"Code Runner",type:"code"},{id:"crypt1",name:"Crypt",type:"crypt"}]},{name:"Reminders",channels:[{id:"reminder1",name:"Reminders",type:"reminder"}]},{name:"Files",channels:[{id:"files1",name:"Files",type:"files"}]},{name:"Settings",channels:[{id:"settings",name:"Settings",type:"settings"}]}],chatMessages={},flashcards={},reminders={};window.whiteboardData=window.whiteboardData||{},window.codeData=window.codeData||{};const readFileAsync=e=>new Promise((t=>{const n=new FileReader;n.onload=n=>t({name:e.name,type:e.type,content:n.target.result}),e.type.startsWith("image/")||e.type.startsWith("video/")||e.type.startsWith("audio/")||"application/pdf"===e.type?n.readAsDataURL(e):n.readAsText(e)})),renderSidebar=()=>{const e=document.querySelector(".topbar");e.innerHTML="",channelCategories.forEach((t=>{const n=createElement("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"}}),a=createElement("div",{class:"channel-list"});t.channels.forEach((e=>{const t=createElement("div",{class:"channel-item","data-channel-id":e.id,"data-channel-type":e.type,oncontextmenu:n=>{if(n.preventDefault(),"function"===e.type){t.textContent="Remove",t.title="Click to remove";const n=a=>{a.stopPropagation();const l=channelCategories.find((e=>"Functions"===e.name));l&&(l.channels=l.channels.filter((t=>t.id!==e.id)),renderSidebar()),t.removeEventListener("click",n)},a=l=>{l.target!==t&&(t.classList.remove("remove-btn"),t.title="",t.textContent=e.name,t.removeEventListener("click",n),document.removeEventListener("click",a))};t.addEventListener("click",n),document.addEventListener("click",a)}},onclick:()=>{if("function"===e.type){const t=channelCategories.flatMap((e=>e.channels)).find((e=>"code"===e.type));t&&(window.codeData[t.id]=e.code,selectChannel(t))}else selectChannel(e)}},e.name);a.appendChild(t)})),n.appendChild(a),e.appendChild(n)})),e.appendChild(createElement("div",{class:"version-text",style:{marginLeft:"auto",padding:"0 1rem",color:"var(--color-text-muted)"}},"v1.46"))};let activeChannelId=null;const selectChannel=e=>{activeChannelId=e.id,document.querySelectorAll(".channel-item").forEach((e=>{e.classList.toggle("active-channel",e.getAttribute("data-channel-id")===activeChannelId)})),renderChannel(e)},renderChannel=e=>{const t=document.querySelector(".main-content");t.innerHTML="";({notes:()=>renderNotesChannel(t,e),flashcard:()=>renderFlashcardChannel(t,e),whiteboard:()=>renderWhiteboardChannel(t,e),code:()=>renderCodeChannel(t,e),reminder:()=>renderReminderChannel(t,e),crypt:()=>renderCryptChannel(t,e),settings:()=>renderSettingsChannel(t,e),files:()=>renderFilesChannel(t,e)}[e.type]||(()=>{}))()},renderNotesChannel=(e,t)=>{e.innerHTML="",Object.assign(e.style,{display:"flex",flexDirection:"column",height:"100%"});const n=createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap"}});e.appendChild(n);const a=createElement("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"center"}});let l=!1;const o=createElement("button",{type:"button",onclick:()=>{l=!l,u.contentEditable=!l,l?o.classList.add("active-btn"):o.classList.remove("active-btn")}},"Read Mode"),i=createElement("input",{type:"file",multiple:!0,style:{display:"none"}}),r=createElement("button",{type:"button",onclick:()=>i.click()},"Attach File"),s=createElement("button",{type:"button",disabled:!0,onclick:()=>{if("true"!==u.contentEditable)return;const e=window.getSelection();if(0===e.rangeCount||!u.contains(e.anchorNode))return;const t=e.toString();if(""===t.trim())return;const n=prompt("Enter the URL to link to:");if(!n)return;const a=document.createElement("a");a.href=n,a.textContent=t,a.target="_blank",a.rel="noopener noreferrer";const l=e.getRangeAt(0);l.deleteContents(),l.insertNode(a),e.removeAllRanges();const o=document.createRange();o.setStartAfter(a),o.setEndAfter(a),e.addRange(o)}},"Linkify");document.addEventListener("selectionchange",(()=>{""!==window.getSelection().toString().trim()?s.disabled=!1:s.disabled=!0})),a.appendChild(o),a.appendChild(i),a.appendChild(r),a.appendChild(s);const c=createElement("div",{style:{display:"flex",marginLeft:"auto"}}),d=createElement("button",{type:"button",onclick:()=>{const e={html:u.innerHTML,files:m},n=new Blob([JSON.stringify(e)],{type:"application/json"});createElement("a",{href:URL.createObjectURL(n),download:`${t.id}_notepad.json`}).click()}},"Export"),p=createElement("input",{type:"file",accept:"application/json",style:{display:"none"},onchange:async e=>{const t=e.target.files[0];if(!t)return;const n=await readFileAsync(t);try{const e=JSON.parse(n.content);u.innerHTML=e.html||"",m=e.files||[]}catch{}}}),h=createElement("button",{type:"button",onclick:()=>p.click()},"Import");c.appendChild(d),c.appendChild(p),c.appendChild(h),n.appendChild(a),n.appendChild(c);const u=createElement("div",{class:"notepad-content",contentEditable:!0});e.appendChild(u);let m=[];const y=async e=>{const t=document.querySelector(".notepad-content"),n=window.getSelection(),a=document.createElement("span");if(a.contentEditable="false",a.style.display="block",a.style.margin="5px 0",e.type.startsWith("image/")){const t=document.createElement("img");t.src=e.content,t.style.maxWidth="300px",t.alt=e.name,a.appendChild(t)}else if(e.type.startsWith("video/")){const t=document.createElement("video");t.src=e.content,t.controls=!0,t.style.maxWidth="400px",a.appendChild(t)}else if(e.type.startsWith("audio/")){const t=document.createElement("audio");t.src=e.content,t.controls=!0,t.style.width="300px",t.style.colorScheme="dark",a.appendChild(t)}else if("application/pdf"===e.type){const t=document.createElement("iframe");t.src=e.content,t.style.width="300px",t.style.height="500px",t.title=e.name,a.appendChild(t)}else{const t=document.createElement("div");t.style.display="inline-block",t.style.maxWidth="300px",t.style.maxHeight="200px",t.style.overflow="auto",t.style.background="transparent",t.style.border="2px solid var(--color-primary)",t.style.padding="10px",t.style.borderRadius="var(--border-radius-circle)";const n=document.createElement("div");n.textContent=e.name,t.appendChild(n);const l=document.createElement("pre");l.textContent=e.content,l.style.margin="0",l.style.whiteSpace="pre-wrap",l.style.wordWrap="break-word",t.appendChild(l),a.appendChild(t)}let l;if(n.rangeCount>0&&t.contains(n.anchorNode)){l=n.getRangeAt(0),l.deleteContents();const{startContainer:e,startOffset:t}=l,o=e.nodeType===Node.TEXT_NODE?e.previousSibling:e.childNodes[t-1];(t>0||e.nodeType===Node.TEXT_NODE&&e.textContent.trim()||o&&"BR"!==o.nodeName&&"SPAN"!==o.nodeName)&&l.insertNode(document.createElement("br")),l.insertNode(a);const i=a.nextSibling;i&&"BR"===i.nodeName||l.insertNode(document.createElement("br"))}else{l=document.createRange();const e=t.lastChild;e&&"BR"!==e.nodeName&&"SPAN"!==e.nodeName&&t.appendChild(document.createElement("br")),t.appendChild(a),a.nextSibling&&"BR"===a.nextSibling.nodeName||t.appendChild(document.createElement("br"))}l.setStartAfter(a),l.collapse(!0),n.removeAllRanges(),n.addRange(l),t.focus()};u.addEventListener("keydown",(e=>{if("Backspace"!==e.key&&"Delete"!==e.key)return;const t=window.getSelection();if(!t.rangeCount||!u.contains(t.anchorNode))return;if(!t.getRangeAt(0).collapsed)return;const n=t.anchorNode,a=t.anchorOffset;if("Backspace"===e.key){if(n.nodeType===Node.TEXT_NODE&&0===a){const t=n.previousSibling;"SPAN"===t?.tagName&&"false"===t.contentEditable&&(t.remove(),e.preventDefault())}else if(n.nodeType===Node.ELEMENT_NODE){const t=a>0?n.childNodes[a-1]:n.previousSibling;"SPAN"===t?.tagName&&"false"===t.contentEditable&&(t.remove(),e.preventDefault())}}else if("Delete"===e.key)if(n.nodeType===Node.TEXT_NODE&&a===n.length){const t=n.nextSibling;"SPAN"===t?.tagName&&"false"===t.contentEditable&&(t.remove(),e.preventDefault())}else if(n.nodeType===Node.ELEMENT_NODE){const t=a<n.childNodes.length?n.childNodes[a]:n.nextSibling;"SPAN"===t?.tagName&&"false"===t.contentEditable&&(t.remove(),e.preventDefault())}"Delete"!==e.key||n!==u||0!==a||u.firstChild||e.preventDefault()})),i.addEventListener("change",(async()=>{const e=await Promise.all(Array.from(i.files).map(readFileAsync));for(const t of e)await y(t),m.push(t);i.value="",u.focus()})),u.addEventListener("input",(()=>{chatMessages[t.id]={html:u.innerHTML,files:m}})),chatMessages[t.id]=chatMessages[t.id]||{html:"",files:[]},u.innerHTML=chatMessages[t.id].html||"",m=chatMessages[t.id].files||[]},renderFlashcardChannel=(e,t)=>{e.innerHTML="";const n=createElement("div",{class:"flashcard-toolbar",style:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),a=createElement("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"center"}}),l=createElement("button",{type:"button",onclick:()=>y()},"Add Answer"),o=createElement("button",{type:"button",onclick:()=>h.requestSubmit()},"Add Flashcard"),i=createElement("button",{type:"button"},"Start Test");a.appendChild(l),a.appendChild(o),a.appendChild(i),n.appendChild(a);const r=createElement("div",{style:{display:"flex",flexWrap:"wrap",marginLeft:"auto"}}),s=createElement("button",{type:"button",onclick:()=>{const e=flashcards[t.id]||[],n=new Blob([JSON.stringify(e)],{type:"application/json"});createElement("a",{href:URL.createObjectURL(n),download:"flashcards.json"}).click()}},"Export");r.appendChild(s);const c=createElement("input",{type:"file",accept:"application/json",style:{display:"none"},onchange:async e=>{const n=e.target.files[0];if(!n)return;const a=await readFileAsync(n);try{const e=JSON.parse(a.content);Array.isArray(e)&&(flashcards[t.id]=flashcards[t.id]||[],e.forEach((e=>{const n=flashcards[t.id].findIndex((t=>t.question===e.question));-1!==n?flashcards[t.id][n]=e:flashcards[t.id].push(e)})),b())}catch{}}});c.addEventListener("click",(()=>{c.value=""})),r.appendChild(c),r.appendChild(createElement("button",{type:"button",onclick:()=>c.click()},"Import")),n.appendChild(r),e.appendChild(n);const d=createElement("div"),p=createElement("div"),h=createElement("form",{class:"flashcard-form",style:{display:"flex",flexWrap:"wrap",flexDirection:"column",marginRight:"10px"},onsubmit:e=>{e.preventDefault();const n=u.value.trim();if(!n)return;const a=Array.from(m.querySelectorAll(".answer-row")).map((e=>{const[t,n]=e.querySelectorAll("input");return n.value.trim()?{text:n.value,correct:t.checked}:null})).filter((e=>e));a.length&&(flashcards[t.id]=flashcards[t.id]||[],flashcards[t.id].push({question:n,answers:a}),u.value="",m.innerHTML="",y(),b())}}),u=createElement("input",{type:"text",placeholder:"Enter question here",required:!0});h.appendChild(u);const m=createElement("div",{id:"answers-container",style:{display:"flex",flexDirection:"column"}});h.appendChild(m);const y=(e="",t=!1)=>{const n=createElement("div",{class:"answer-row",style:{display:"flex",alignItems:"center"}});n.appendChild(createElement("input",{type:"checkbox",title:"Mark as correct answer",checked:t})),n.appendChild(createElement("input",{type:"text",placeholder:"Answer",required:!0,value:e,style:{flex:"1"}})),n.appendChild(createElement("button",{type:"button",onclick:()=>n.remove()},"Remove")),m.appendChild(n)};y(),p.appendChild(h);const g=createElement("div");p.appendChild(g);const f=createElement("div",{style:{display:"none"}});d.appendChild(p),d.appendChild(f),e.appendChild(d);const b=()=>{g.innerHTML="",(flashcards[t.id]=flashcards[t.id]||[]).forEach(((e,n)=>{const a=createElement("div",{class:"flashcard"}),l=createElement("p",{},"Q: "+e.question);a.appendChild(l);const o=createElement("div");e.answers.forEach((e=>{const t=createElement("div",{class:e.correct?"correct-highlight":"",style:{display:"flex",alignItems:"center"}}),n=createElement("input",{type:"checkbox",checked:e.correct,disabled:!0});t.appendChild(n),t.appendChild(document.createTextNode(e.text)),o.appendChild(t)})),a.appendChild(o);const i=createElement("div",{class:"toolbar"}),r=createElement("button",{type:"button",onclick:function(){if("Edit"===this.textContent){const t=createElement("input",{type:"text",value:e.question,style:{width:"100%"}});a.replaceChild(t,l);const n=createElement("div");e.answers.forEach((e=>{const t=createElement("div",{class:"answer-row",style:{display:"flex",alignItems:"center"}});t.appendChild(createElement("input",{type:"checkbox",checked:e.correct})),t.appendChild(createElement("input",{type:"text",value:e.text,style:{flex:"1"}})),n.appendChild(t)})),a.replaceChild(n,o);const r=createElement("button",{type:"button",onclick:()=>{const e=createElement("div",{class:"answer-row",style:{display:"flex",alignItems:"center"}});e.appendChild(createElement("input",{type:"checkbox"})),e.appendChild(createElement("input",{type:"text",placeholder:"New answer",style:{flex:"1"}})),n.appendChild(e)}},"Add Answer");i.insertBefore(r,this.nextSibling),this.textContent="Save"}else{const t=a.querySelector("input[type='text']");e.question=t.value;const n=[];a.querySelectorAll(".answer-row").forEach((e=>{const[t,a]=e.querySelectorAll("input");a.value.trim()&&n.push({text:a.value,correct:t.checked})})),e.answers=n;const l=i.querySelector("button:nth-child(3)");l&&"Add Answer"===l.textContent&&i.removeChild(l),b()}}},"Edit");i.appendChild(r),i.appendChild(createElement("button",{type:"button",onclick:()=>{flashcards[t.id].splice(n,1),b()}},"Remove")),a.appendChild(i),g.appendChild(a)})),i.disabled=!flashcards[t.id]?.length};b(),i.addEventListener("click",(()=>{p.style.display="none",v(f,t),f.style.display="block"}));const v=(e,t)=>{e.innerHTML="";const n=[...flashcards[t.id]||[]].sort((()=>Math.random()-.5));if(!n.length)return void(e.textContent="No flashcards available for testing.");const a=n.map((e=>{const t=e.answers.slice();for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return{question:e.question,answers:t}})),l=createElement("form",{onsubmit:e=>{e.preventDefault();let t=0;a.forEach(((e,n)=>{const a=Array.from(l.querySelectorAll(`input[name="card${n}"]:checked`)).map((e=>+e.value)),o=e.answers.map(((e,t)=>e.correct?t:null)).filter((e=>null!==e));a.sort().toString()===o.sort().toString()&&t++,l.querySelectorAll(`input[name="card${n}"]`).forEach((e=>{const t=+e.value;o.includes(t)?e.parentElement.classList.add("correct-highlight"):e.checked&&e.parentElement.classList.add("incorrect-highlight"),e.disabled=!0}))})),l.querySelector("button[type='submit']").disabled=!0,l.appendChild(createElement("div",{},`Your score: ${t} / ${a.length}`))}});a.forEach(((e,t)=>{const n=createElement("div");n.appendChild(createElement("p",{},"Q: "+e.question)),e.answers.forEach(((e,a)=>{const l=createElement("label",{style:{display:"flex",alignItems:"center"}});l.appendChild(createElement("input",{type:"checkbox",name:`card${t}`,value:a})),l.appendChild(document.createTextNode(e.text)),n.appendChild(l)})),l.appendChild(n)})),l.appendChild(createElement("button",{type:"submit"},"Submit Answers")),l.appendChild(createElement("button",{type:"button",onclick:()=>{e.style.display="none",p.style.display="block"}},"Back")),e.appendChild(l)}},renderWhiteboardChannel=(e,t)=>{e.innerHTML="",Object.assign(e.style,{display:"flex",flexDirection:"column"});const n=e=>structuredClone(e),a=30,l="#696969",o=(e,t)=>{if(e.length<=2)return e;const n=1/t,[a,l]=e[0],[i,r]=e[e.length-1];let s=0,c=0;for(let t=1;t<e.length-1;t++){const[n,o]=e[t],d=Math.abs((r-l)*n-(i-a)*o+i*l-r*a)/Math.sqrt((r-l)**2+(i-a)**2);d>s&&(s=d,c=t)}if(s>n){const n=o(e.slice(0,c+1),t),a=o(e.slice(c),t);return n.slice(0,-1).concat(a)}return[e[0],e[e.length-1]]},i=(e,t)=>{let n=f*v%a,l=b*v%a;return n<0&&(n+=a),l<0&&(l+=a),{x:n+Math.round((e-n)/a)*a,y:l+Math.round((t-l)/a)*a}},r=(e,t,n,a)=>{for(let l=1;l<e.points.length;l++){const[o,i]=e.points[l-1],[r,s]=e.points[l],c=r-o,d=s-i,p=c*c+d*d;let h=0!==p?((t-o)*c+(n-i)*d)/p:-1;h=Math.max(0,Math.min(1,h));const u=o+h*c,m=i+h*d;if(Math.sqrt((t-u)**2+(n-m)**2)<=a+e.size/2)return!0}return!1},s=(e,t)=>{const n=({brush:[[3,0],[4,0],[2,1],[3,1],[4,1],[1,2],[2,2],[3,2],[1,3],[2,3],[0,4]],eraser:[[2,0],[3,0],[4,0],[1,1],[2,1],[3,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[1,3],[2,3],[3,3],[0,4],[1,4],[2,4]],pan:[[2,0],[2,1],[0,2],[1,2],[2,2],[3,2],[4,2],[2,3],[2,4]],snap:[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]],copy:[[1,0],[2,0],[3,0],[4,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[3,2],[4,2],[0,3],[3,3],[4,3],[0,4],[1,4],[2,4],[3,4]],copyDisabled:[[1,0],[2,0],[3,0],[4,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[3,2],[4,2],[0,3],[3,3],[4,3],[0,4],[1,4],[2,4],[3,4]],cut:[[0,0],[4,0],[1,1],[3,1],[2,2],[0,3],[1,3],[3,3],[4,3],[0,4],[1,4],[3,4],[4,4]],cutDisabled:[[0,0],[4,0],[1,1],[3,1],[2,2],[0,3],[1,3],[3,3],[4,3],[0,4],[1,4],[3,4],[4,4]],select:[[0,0],[2,0],[4,0],[0,2],[4,2],[0,4],[2,4],[4,4]],zoomIn:[[0,0],[1,0],[2,0],[3,0],[0,1],[3,1],[0,2],[3,2],[0,3],[1,3],[2,3],[3,3],[4,4]],zoomOut:[[0,0],[1,0],[2,0],[0,1],[2,1],[0,2],[1,2],[2,2],[3,3],[4,4]],attach:[[0,0],[1,0],[2,0],[0,1],[3,1],[0,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]],dotsVisibility:[[0,0],[2,0],[4,0],[0,2],[2,2],[4,2],[0,4],[2,4],[4,4]],undo:[[1,0],[0,1],[1,1],[2,1],[3,1],[4,1],[1,2],[4,2],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]],undoDisabled:[[1,0],[0,1],[1,1],[2,1],[3,1],[4,1],[1,2],[4,2],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]],redo:[[3,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[3,2],[0,3],[0,4],[1,4],[2,4],[3,4],[4,4]],redoDisabled:[[3,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[3,2],[0,3],[0,4],[1,4],[2,4],[3,4],[4,4]]}[e]||[]).map((([e,n])=>`<rect x="${e}" y="${n}" width="1" height="1" fill="${t}"/>`)).join("");return`url('data:image/svg+xml,${encodeURIComponent(`<svg width="5" height="5" xmlns="http://www.w3.org/2000/svg">${n}</svg>`)}')`},c=createElement("div",{class:"toolbar",style:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),d=createElement("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"center"}});let p,h,u,m,y,g,f,b,v,w,E,C="#fff",x=1,S=1,k=0,I=0,D=0,T=0,A=!0,L=!1,M=!1,R=!1,N=!1,P=null,F=null,j=0,$=0,U=null,O=!1,W=null,_=!1,B=null,H=!1,q=!1,J=!0,z=[],G=[];const Z=e=>{z.push(e),z.length>10&&z.shift(),G=[],V()},V=()=>{ye.disabled=0===z.length,ye.style.backgroundImage=ye.disabled?s("undoDisabled","gray"):s("undo","white"),ge.disabled=0===G.length,ge.style.backgroundImage=ge.disabled?s("redoDisabled","gray"):s("redo","white")},Y=(e,t,n)=>(A=L=M=R=!1,e=!e,X.style.backgroundImage=s("brush","white"),te.style.backgroundImage=s("eraser","white"),ne.style.backgroundImage=s("pan","white"),de.style.backgroundImage=s("select","white"),t.style.backgroundImage=s(t.title.toLowerCase(),e?n:"white"),pe.disabled=!0,pe.style.backgroundImage=s("copyDisabled","gray"),he.disabled=!0,he.style.backgroundImage=s("cutDisabled","gray"),P=null,p.style.cursor=e&&t===de?"crosshair":"none",e),X=createElement("button",{class:"button-icn",onclick:()=>{A=Y(A,X,"#ff5100"),Me()},style:{backgroundImage:s("brush","#ff5100")},title:"Brush"}),K=createElement("input",{type:"range",min:"0.3",max:"10",step:"0.1",value:"1",onchange:e=>{S=+e.target.value,Me()}}),Q=createElement("input",{type:"color",value:"#ffffff",style:{colorScheme:"dark"},oninput:e=>{C=e.target.value,Me()}}),ee=createElement("input",{type:"range",min:"1",max:"20",value:"1",onchange:e=>{x=+e.target.value,Re()}}),te=createElement("button",{class:"button-icn",onclick:()=>{L=Y(L,te,"#ff0000"),Re()},style:{backgroundImage:s("eraser","white")},title:"Eraser"}),ne=createElement("button",{class:"button-icn",onclick:()=>{M=Y(M,ne,"#ff5100"),Me()},style:{backgroundImage:s("pan","white")},title:"Pan"}),ae=e=>createElement("button",{class:"button-icn",onclick:()=>{zoomTargetScale=Math.max(.1,Math.min(e?2*v:v/2,10));const t=p.width/2,n=p.height/2;f+=t/zoomTargetScale-t/v,b+=n/zoomTargetScale-n/v,v=zoomTargetScale,u.panZoom={offsetX:f,offsetY:b,scale:v},Te(),Me()},style:{backgroundImage:s(e?"zoomIn":"zoomOut","white")},title:e?"Zoom In":"Zoom Out"}),le=ae(!0),oe=ae(!1),ie=createElement("button",{class:"button-icn",onclick:()=>{J=!J,ie.style.backgroundImage=s("dotsVisibility",J?"#ff5100":"white"),u.areDotsVisible=J,Te(),Me()},style:{backgroundImage:s("dotsVisibility","#ff5100")},title:"Toggle Dots"});let re="#17161e";const se=createElement("input",{type:"color",value:re,style:{colorScheme:"dark"},oninput:e=>{re=e.target.value,u.backgroundColor=re,Me()}}),ce=createElement("button",{class:"button-icn",onclick:()=>{N=!N,ce.style.backgroundImage=s("snap",N?"#ff5100":"white")},style:{backgroundImage:s("snap","white")},title:"Snap"}),de=createElement("button",{class:"button-icn",onclick:()=>{R=Y(R,de,"#ff5100"),R||(F=null,P=null,Me())},style:{backgroundImage:s("select","white")},title:"Select"}),pe=createElement("button",{class:"button-icn",onclick:()=>$e(!1),disabled:!0,style:{backgroundImage:s("copyDisabled","gray")},title:"Copy"}),he=createElement("button",{class:"button-icn",onclick:()=>$e(!0),disabled:!0,style:{backgroundImage:s("cutDisabled","gray")},title:"Cut"}),ue=createElement("input",{type:"file",accept:"image/*",style:{display:"none"},onchange:e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=()=>{const t=e.result,n=new Image;n.onload=()=>{const e=n.naturalWidth,a=n.naturalHeight,l=.25*(p.width/v),o=l*(a/e),i=Ie(p.width/2)-l/2,r=De(p.height/2)-o/2;y.push({dataUrl:t,x:i,y:r,width:l,height:o}),g.push(n),Me()},n.src=t},e.readAsDataURL(t)}ue.value=""}}),me=createElement("button",{class:"button-icn",onclick:()=>ue.click(),style:{backgroundImage:s("attach","white")},title:"Attach"}),ye=createElement("button",{class:"button-icn",onclick:()=>{if(0===z.length)return;const e=z.pop();switch(G.push(e),e.type){case"draw":case"erase":u.paths=e.prevState.paths,m=u.paths;break;case"copy":case"cut":case"paste":u.paths=e.prevState.paths,m=u.paths;break}V(),Me()},disabled:!0,style:{backgroundImage:s("undoDisabled","gray")},title:"Undo"}),ge=createElement("button",{class:"button-icn",onclick:()=>{if(0===G.length)return;const e=G.pop();switch(z.push(e),e.type){case"draw":case"erase":u.paths=e.nextState.paths,m=u.paths;break;case"copy":case"cut":case"paste":u.paths=e.nextState.paths,m=u.paths;break}V(),Me()},disabled:!0,style:{backgroundImage:s("redoDisabled","gray")},title:"Redo"});d.append(X,K,Q,te,ee,ne,le,oe,ce,de,pe,he,me,ie,se,ye,ge),c.appendChild(d);const fe=createElement("div",{style:{display:"flex",flexWrap:"wrap",marginLeft:"auto"}}),be=createElement("button",{type:"button",onclick:()=>{try{const e={paths:Array.isArray(u.paths)?u.paths:[],images:Array.isArray(u.images)?u.images.map((e=>({dataUrl:"string"==typeof e.dataUrl?e.dataUrl:"",x:Number.isFinite(e.x)?e.x:0,y:Number.isFinite(e.y)?e.y:0,width:Number.isFinite(e.width)?e.width:0,height:Number.isFinite(e.height)?e.height:0}))):[],panZoom:u.panZoom||{offsetX:0,offsetY:0,scale:1},areDotsVisible:void 0===u.areDotsVisible||u.areDotsVisible,backgroundColor:u.backgroundColor||"#212121"},t=JSON.stringify(e);if(!t)throw new Error("JSON serialization failed");const n=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(n);createElement("a",{href:a,download:`whiteboard_${Date.now()}.json`}).click(),setTimeout((()=>URL.revokeObjectURL(a)),100)}catch(e){alert("Failed to export JSON: "+e.message)}}},"Export JSON"),ve=createElement("button",{type:"button",onclick:()=>{try{const{offsetX:e,offsetY:t,scale:n}=u.panZoom||{offsetX:0,offsetY:0,scale:1},a=u.paths||[],l=u.images||[];let o=1/0,i=1/0,r=-1/0,s=-1/0;a.forEach((e=>{!Array.isArray(e.points)||e.points.length<1||e.points.forEach((([e,t])=>{o=Math.min(o,e),i=Math.min(i,t),r=Math.max(r,e),s=Math.max(s,t)}))})),l.forEach((e=>{e.dataUrl&&(o=Math.min(o,e.x),i=Math.min(i,e.y),r=Math.max(r,e.x+(e.width||0)),s=Math.max(s,e.y+(e.height||0)))}));const c=10;o===1/0&&(o=0,i=0,r=100,s=100);const d=Math.round(10*(r-o+2*c))/10,p=Math.round(10*(s-i+2*c))/10,h=Math.round(10*(o-c))/10;let m=`<svg width="${d}" height="${p}" viewBox="${h} ${Math.round(10*(i-c))/10} ${d} ${p}" xmlns="http://www.w3.org/2000/svg">`;a.forEach((e=>{if(!Array.isArray(e.points)||e.points.length<2)return;const t=e.points.map((([e,t])=>[Math.round(10*e)/10,Math.round(10*t)/10]));let n=`M${t[0][0]} ${t[0][1]}`,a=t[0][0],l=t[0][1],o=0,i=0;if(2===t.length){n+=`l${Math.round(100*(t[1][0]-a))/100} ${Math.round(100*(t[1][1]-l))/100}`}else for(let e=0;e<t.length-1;e++){const r=t[e>0?e-1:e],s=t[e],c=t[e+1],d=t[e+2<t.length?e+2:e+1],p=.3,h=Math.round((c[0]-r[0])*p*100)/100,u=Math.round((c[1]-r[1])*p*100)/100,m=Math.round((d[0]-s[0])*p*100)/100,y=Math.round((d[1]-s[1])*p*100)/100,g=Math.round(100*h)/100,f=Math.round(100*u)/100,b=Math.round(100*(c[0]-s[0]-m))/100,v=Math.round(100*(c[1]-s[1]-y))/100,w=Math.round(100*(c[0]-s[0]))/100,E=Math.round(100*(c[1]-s[1]))/100;if(0===e)n+=`c${g} ${f} ${b} ${v} ${w} ${E}`;else{Math.round(100*-o),Math.round(100*-i);n+=`s${b} ${v} ${w} ${E}`}o=b,i=v,a=c[0],l=c[1]}m+=`<path d="${n}" stroke="${e.color||"#fff"}" stroke-width="${e.size||1}" stroke-linecap="round" fill="none"/>`})),l.forEach((e=>{if(!e.dataUrl)return;const t=Math.round(10*e.x)/10,n=Math.round(10*e.y)/10,a=Math.round(10*(e.width||0))/10,l=Math.round(10*(e.height||0))/10;m+=`<image x="${t}" y="${n}" width="${a}" height="${l}" href="${e.dataUrl}"/>`})),m+="</svg>";const y=new Blob([m],{type:"image/svg+xml"}),g=URL.createObjectURL(y);createElement("a",{href:g,download:`whiteboard_${Date.now()}.svg`}).click(),setTimeout((()=>URL.revokeObjectURL(g)),100)}catch(e){alert("Failed to export SVG: "+e.message)}}},"Export SVG");fe.appendChild(be),fe.appendChild(ve);const we=createElement("input",{type:"file",accept:"application/json",style:{display:"none"},onchange:e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=()=>{try{const e=JSON.parse(n.result);e.paths&&e.images&&e.panZoom&&(u.paths=e.paths,u.images=e.images,u.panZoom=e.panZoom,m=u.paths,y=u.images,({offsetX:f,offsetY:b,scale:v}=u.panZoom),g=[],e.images.forEach((e=>{const t=new Image;t.onload=()=>Me(),t.src=e.dataUrl,g.push(t)})),Te(),Me())}catch(e){}},n.readAsText(t)}});fe.appendChild(we),fe.appendChild(createElement("button",{type:"button",onclick:()=>we.click()},"Import")),c.appendChild(fe),e.appendChild(c);const Ee=createElement("div",{class:"whiteboard-container"});p=createElement("canvas",{style:{cursor:"none"},class:"whiteboard-context"}),Ee.appendChild(p),e.appendChild(Ee),h=p.getContext("2d"),document.oncontextmenu=()=>!1,window.whiteboardData[t.id]=window.whiteboardData[t.id]||{paths:[],images:[],panZoom:{offsetX:0,offsetY:0,scale:1},areDotsVisible:!0,backgroundColor:"#17161e"},u=window.whiteboardData[t.id],m=u.paths,y=u.images,g=[],({offsetX:f,offsetY:b,scale:v}=u.panZoom),J=u.areDotsVisible,re=u.backgroundColor,ie.style.backgroundImage=s("dotsVisibility",J?"#ff5100":"white"),se.value=re,y.forEach((e=>{const t=new Image;t.onload=()=>Me(),t.src=e.dataUrl,g.push(t)}));const Ce=document.createElement("canvas"),xe=Ce.getContext("2d"),Se=e=>(e+f)*v,ke=e=>(e+b)*v,Ie=e=>e/v-f,De=e=>e/v-b,Te=(e=v)=>{Ce.width=Ee.clientWidth||1,Ce.height=Ee.clientHeight||1;let t=f*e%a,n=b*e%a;if(t<0&&(t+=a),n<0&&(n+=a),xe.fillStyle=l,xe.clearRect(0,0,Ce.width,Ce.height),J)for(let e=t;e<Ce.width;e+=a)for(let t=n;t<Ce.height;t+=a)xe.beginPath(),xe.arc(e,t,1,0,2*Math.PI),xe.fill()},Ae=e=>{h.beginPath();const t=e.points;if(t.length<2)return;const[n,a]=t[0];if(h.moveTo(Se(n),ke(a)),e.snapped)for(let e=1;e<t.length;e++){const[n,a]=t[e];h.lineTo(Se(n),ke(a))}else if(2===t.length){const[e,n]=t[1];h.lineTo(Se(e),ke(n))}else{for(let e=1;e<t.length-1;e++){const[n,a]=t[e-1],[l,o]=t[e],[i,r]=t[e+1],s=(l+i)/2,c=(o+r)/2;h.quadraticCurveTo(Se(l),ke(o),Se(s),ke(c))}const[e,n]=t[t.length-1];h.lineTo(Se(e),ke(n))}h.strokeStyle=e.color,h.lineWidth=e.size*v,h.lineCap="round",h.stroke()},Le=()=>{if(p.width=Ee.clientWidth,p.height=Ee.clientHeight,h.fillStyle=re,h.fillRect(0,0,p.width,p.height),h.drawImage(Ce,0,0),y.forEach(((e,t)=>{const n=g[t];n&&n.complete&&h.drawImage(n,Se(e.x),ke(e.y),e.width*v,e.height*v)})),m.forEach(Ae),U&&Ae(U),M){const e=p.width/2,t=p.height/2;h.save(),h.strokeStyle=l,h.lineWidth=1,h.beginPath(),h.moveTo(0,t),h.lineTo(p.width,t),h.moveTo(e,0),h.lineTo(e,p.height),h.stroke(),h.restore()}if(F){const e=Math.min(F.x0,F.x1),t=Math.max(F.x0,F.x1),n=Math.min(F.y0,F.y1),a=Math.max(F.y0,F.y1),l=Se(t)-Se(e),o=ke(a)-ke(n),i=Se(e),r=ke(n);((e,t,n,a,l,o,i,r,s)=>{e.save(),e.strokeStyle=i,e.lineWidth=r,e.setLineDash(s),e.beginPath(),e.moveTo(t+o,n),e.lineTo(t+a-o,n),e.quadraticCurveTo(t+a,n,t+a,n+o),e.lineTo(t+a,n+l-o),e.quadraticCurveTo(t+a,n+l,t+a-o,n+l),e.lineTo(t+o,n+l),e.quadraticCurveTo(t,n+l,t,n+l-o),e.lineTo(t,n+o),e.quadraticCurveTo(t,n,t+o,n),e.closePath(),e.stroke(),e.restore()})(h,i,r,l,o,6,"#6e6e6e",2,[10,5])}if(W){const e=Se(W.x+W.width),t=ke(W.y);h.save(),h.fillStyle="red",h.beginPath(),h.roundRect(e-10,t-10,20,20,5),h.fill(),h.strokeStyle="white",h.lineWidth=2,h.beginPath(),h.moveTo(e-5,t-5),h.lineTo(e+5,t+5),h.moveTo(e+5,t-5),h.lineTo(e-5,t+5),h.stroke(),h.restore()}},Me=((e,t)=>{let n;return(...a)=>{n||(e(...a),n=setTimeout((()=>n=null),t))}})(Le,16),Re=()=>{if(R&&P){let e=Ie(k)-j/2,t=De(I)-$/2;if(N){const n=i(Se(e),ke(t));e=Ie(n.x),t=De(n.y)}h.save(),h.globalAlpha=.5,P.forEach((n=>{h.beginPath();const[a,l]=n.points[0];h.moveTo(Se(a+e),ke(l+t));for(let a=1;a<n.points.length;a++){const[l,o]=n.points[a];h.lineTo(Se(l+e),ke(o+t))}h.strokeStyle=n.color,h.lineWidth=n.size*v,h.lineCap="round",h.stroke()})),h.restore()}else if(H){const e=L?4*x:x;h.beginPath(),h.arc(k,I,e/2+1,0,2*Math.PI),h.strokeStyle=L?"red":"gray",h.lineWidth=1,h.stroke()}},Ne=(e,t)=>{const n=e.getBoundingClientRect();return{x:t.touches[0].clientX-n.left,y:t.touches[0].clientY-n.top}},Pe=(e,t)=>{const a=Ie(e),l=De(t);if(W){const n=Se(W.x+W.width),a=ke(W.y);if(Math.sqrt((e-n)**2+(t-a)**2)<10){const e=y.indexOf(W);return-1!==e&&(y.splice(e,1),g.splice(e,1)),W=null,void Me()}}const o=((e,t)=>{for(let n=y.length-1;n>=0;n--){const{x:a,y:l,width:o,height:i}=y[n];if(e>=a&&e<=a+o&&t>=l&&t<=l+i)return y[n]}return null})(a,l);if(o&&!A&&!L&&!M&&!R)return W=o,_=!0,B=o,w=a-o.x,E=l-o.y,void Me();if(W=null,O=!0,R&&P){let a=Ie(e)-j/2,l=De(t)-$/2;if(N){const e=i(Se(a),ke(l));a=Ie(e.x),l=De(e.y)}const o={paths:n(m)};P.forEach((e=>m.push({points:e.points.map((([e,t])=>[e+a,t+l])),color:e.color,size:e.size,snapped:e.snapped})));const r={paths:n(m)};return Z({type:"paste",prevState:o,nextState:r}),void Me()}if(A&&!L&&!M&&!R){const e=N?i(Se(a),ke(l)):{x:Se(a),y:ke(l)};U={points:[[Ie(e.x),De(e.y)]],color:C,size:x/v,snapped:N}}R&&!P&&(F={x0:a,y0:l,x1:a,y1:l}),k=D=e,I=T=t},Fe=(e,t)=>{k=e,I=t;const a=Ie(e),l=De(t);if(e<0||e>p.width||t<0||t>p.height){if(O&&U&&A){const e={paths:n(m)};m.push(U);const t={paths:n(m)};Z({type:"draw",prevState:e,nextState:t}),U=null,O=!1,Me()}q=!0}else{if(_)B.x=a-w,B.y=l-E,q=!0;else if(O){if(M)f+=(k-D)/v,b+=(I-T)/v,u.panZoom={offsetX:f,offsetY:b,scale:v},Te(),q=!0;else if(L){const e=2*x/v,t={paths:n(m)};let o=!1;for(let t=m.length-1;t>=0;t--)r(m[t],a,l,e)&&(m.splice(t,1),o=!0);if(o){const e={paths:n(m)};Z({type:"erase",prevState:t,nextState:e})}}else if(R&&!P&&F)F.x1=a,F.y1=l,q=!0;else if(U&&A){const e=N?i(Se(a),ke(l)):{x:Se(a),y:ke(l)};U.points.push([Ie(e.x),De(e.y)]),U.points.length>2&&(U.points=o(U.points,v))}D=k,T=I}q=!0}},je=()=>{if(_)_=!1,B=null;else if(O){if(U&&U.points.length>1){const e={paths:n(m)};m.push(U);const t={paths:n(m)};Z({type:"draw",prevState:e,nextState:t})}U=null,O=!1,R&&F&&!P&&(pe.disabled=!1,pe.style.backgroundImage=s("copy","white"),he.disabled=!1,he.style.backgroundImage=s("cut","white")),Me()}},$e=e=>{if(!F)return;const t=Math.min(F.x0,F.x1),a=Math.max(F.x0,F.x1),l=Math.min(F.y0,F.y1),o=Math.max(F.y0,F.y1);j=a-t,$=o-l;const i=[],r=[];if(m.forEach(((n,s)=>{Ue(n,t,l,a,o)&&(i.push(n),e&&r.push(s))})),P=i.map((e=>({points:e.points.map((([e,n])=>[e-t,n-l])),color:e.color,size:e.size,snapped:e.snapped}))),e){const e={paths:n(m)};for(let e=r.length-1;e>=0;e--)m.splice(r[e],1);const t={paths:n(m)};Z({type:"cut",prevState:e,nextState:t})}else Z({type:"copy",prevState:{paths:JSON.parse(JSON.stringify(m))},nextState:{paths:JSON.parse(JSON.stringify(m))}});F=null,pe.disabled=!0,pe.style.backgroundImage=s("copyDisabled","gray"),he.disabled=!0,he.style.backgroundImage=s("cutDisabled","gray"),Me()},Ue=(e,t,n,a,l)=>{for(let o=1;o<e.points.length;o++){const[i,r]=e.points[o-1],[s,c]=e.points[o];if(i>=t&&i<=a&&r>=n&&r<=l||s>=t&&s<=a&&c>=n&&c<=l)return!0;if(Oe(i,r,s,c,t,n,a,l))return!0}return!1},Oe=(e,t,n,a,l,o,i,r)=>We(e,t,n,a,l,o,l,r)||We(e,t,n,a,i,o,i,r)||We(e,t,n,a,l,o,i,o)||We(e,t,n,a,l,r,i,r),We=(e,t,n,a,l,o,i,r)=>{const s=(r-o)*(n-e)-(i-l)*(a-t);if(0===s)return!1;const c=((i-l)*(t-o)-(r-o)*(e-l))/s,d=((n-e)*(t-o)-(a-t)*(e-l))/s;return c>=0&&c<=1&&d>=0&&d<=1};p.addEventListener("mousedown",(e=>{0===e.button&&Pe(e.offsetX,e.offsetY)})),p.addEventListener("touchstart",(e=>{e.preventDefault();const t=Ne(p,e);H=!0,Pe(t.x,t.y)}),{passive:!1}),p.addEventListener("mousemove",(e=>{k=e.offsetX,I=e.offsetY,H=!0,Fe(e.offsetX,e.offsetY)})),p.addEventListener("touchmove",(e=>{const t=Ne(p,e);(O||M||_)&&e.preventDefault(),H=!0,Fe(t.x,t.y)}),{passive:!1}),p.addEventListener("mouseup",je),p.addEventListener("touchend",(e=>{e.preventDefault(),H=!1,je(),q=!0}),{passive:!1}),p.addEventListener("mouseleave",(()=>{if(H=!1,O&&je(),O&&U&&A){const e={paths:n(m)};m.push(U);const t={paths:n(m)};Z({type:"draw",prevState:e,nextState:t}),U=null,O=!1,Me()}q=!0})),p.addEventListener("touchcancel",(e=>{e.preventDefault(),H=!1,je(),q=!0}),{passive:!1}),document.addEventListener("paste",(e=>{const t=(e.clipboardData||e.originalEvent.clipboardData).items;for(const e of t)if(0===e.type.indexOf("image")){const t=e.getAsFile(),n=new FileReader;n.onload=()=>{const e=n.result,t=new Image;t.onload=()=>{const n=t.naturalWidth,a=t.naturalHeight,l=.25*(p.width/v),o=l*(a/n),i=Ie(k||p.width/2)-l/2,r=De(I||p.height/2)-o/2;y.push({dataUrl:e,x:i,y:r,width:l,height:o}),g.push(t),Me()},t.src=e},n.readAsDataURL(t);break}e.preventDefault()}));let _e=0,Be=0,He="";const qe=()=>{!q&&k===_e&&I===Be&&A===("brush"===He)&&H||(Le(),Re(),_e=k,Be=I,He=A?"brush":"other",q=!1),requestAnimationFrame(qe)};window.addEventListener("resize",(()=>{Te(),Me()})),Te(),Me(),V(),requestAnimationFrame(qe)},renderCodeChannel=(container,channel)=>{container.innerHTML="",container.style.display="flex",container.style.flexDirection="column";const headerContainer=createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),buttonContainer=createElement("div",{style:{display:"flex",flexWrap:"wrap",marginLeft:"auto"}}),saveButton=createElement("button",{},"Save");buttonContainer.appendChild(saveButton);const runButton=createElement("button",{},"Run Code");buttonContainer.appendChild(runButton),buttonContainer.appendChild(createElement("button",{onclick:()=>{const e=channelCategories.find((e=>"Functions"===e.name));if(!e?.channels?.length)return;const t=new Blob([JSON.stringify(e.channels)],{type:"application/json"});createElement("a",{href:URL.createObjectURL(t),download:"code_functions.json"}).click()}},"Export")),buttonContainer.appendChild(createElement("button",{onclick:()=>{const e=createElement("input",{type:"file",accept:"application/json",style:{display:"none"}});e.addEventListener("change",(async e=>{const t=e.target.files[0];if(!t)return;const n=await readFileAsync(t);try{const e=JSON.parse(n.content);if(Array.isArray(e)){let t=channelCategories.find((e=>"Functions"===e.name));t||(t={name:"Functions",channels:[]},channelCategories.push(t)),e.forEach((e=>{const n=t.channels.findIndex((t=>t.name.toLowerCase()===e.name.toLowerCase()));-1!==n?t.channels[n]=e:t.channels.push(e)})),renderSidebar()}}catch{}})),e.click()}},"Import")),headerContainer.appendChild(buttonContainer),container.appendChild(headerContainer);const ioContainer=createElement("div",{class:"toolbar",style:{display:"flex",alignItems:"center"}}),functionNameInput=createElement("input",{type:"text",placeholder:"Function Name..",style:{flex:"1",minWidth:"80px"}});ioContainer.appendChild(functionNameInput),container.appendChild(ioContainer);const wrapper=createElement("div",{class:"code-runner-wrapper"});container.appendChild(wrapper);const codeTextarea=createElement("textarea",{spellcheck:"false",class:"code-runner-textarea"});wrapper.appendChild(codeTextarea),window.codeData[channel.id]&&(codeTextarea.value=window.codeData[channel.id]),codeTextarea.addEventListener("input",(()=>{window.codeData[channel.id]=codeTextarea.value}));const outputDiv=createElement("div",{class:"code-runner-output"});wrapper.appendChild(outputDiv),runButton.addEventListener("click",(()=>{const code=codeTextarea.value,logs=[],originalLog=console.log;console.log=(...e)=>{logs.push(e.join(" ")),originalLog(...e)};try{const result=eval(code);outputDiv.textContent=logs.length?logs.join("\n"):void 0!==result?result:"Code executed successfully."}catch(e){outputDiv.textContent="Error: "+e}console.log=originalLog})),functionNameInput.addEventListener("input",(()=>{const e=channelCategories.find((e=>"Functions"===e.name));saveButton.textContent=e&&e.channels.find((e=>e.name.toLowerCase()===functionNameInput.value.trim().toLowerCase()))?"Update":"Save"})),saveButton.addEventListener("click",(()=>{const e=codeTextarea.value;if(!e.trim())return;let t=channelCategories.find((e=>"Functions"===e.name));t||(t={name:"Functions",channels:[]},channelCategories.push(t));let n=functionNameInput.value.trim()||"Saved Function "+(t.channels.length+1);const a=t.channels.findIndex((e=>e.name.toLowerCase()===n.toLowerCase()));if(-1!==a)t.channels[a].code=e;else{const a="func_"+Date.now()+"_"+Math.random().toString(36).substring(2,9);t.channels.push({id:a,name:n,type:"function",code:e})}renderSidebar(),saveButton.textContent="Save"}))},renderCryptChannel=(e,t)=>{e.innerHTML="";const n=createElement("div",{class:"crypt-container",style:{display:"flex",flexDirection:"column"}}),a=createElement("div",{class:"iosec",style:{display:"flex",justifyContent:"space-between",flexWrap:"wrap"}});let l=!1,o="",i="";const r=()=>{const e=c.value||l,t=R.value,n=f.value&&!f._binaryData,a=l&&f._binaryData;A.disabled=!e||!t,L.disabled=!e||!t,d.disabled=!c.value,N.disabled=!t,w.disabled=!a,v.disabled=!n},s=createElement("div",{style:{flex:"1",marginRight:"5px"}}),c=createElement("textarea",{placeholder:"Enter your message here",rows:"10",class:"crypt-textarea"}),d=createElement("button",{onclick:()=>{navigator.clipboard.writeText(c.value)},disabled:!0},"Copy Message"),p=createElement("button",{onclick:()=>{m.click()}},"Attach File"),h=createElement("button",{onclick:()=>{l=!1,o="",i="",c.disabled=!1,f.disabled=!0,c.value="",f.value="",c.placeholder="Enter your message here",f.placeholder="The result will appear here",h.style.display="none",p.style.display="inline",u.textContent="",r()},style:{display:"none"}},"Clear File"),u=createElement("div",{style:{marginTop:"5px",fontSize:"12px",color:"#666"}}),m=createElement("input",{type:"file",style:{display:"none"}});m.addEventListener("click",(()=>{m.value=""})),m.addEventListener("change",(function(){if(m.files&&m.files[0]){const e=m.files[0];o=e.name,i=e.type||"application/octet-stream",l=!0,c.disabled=!0,f.disabled=!0,c.placeholder="File content loaded (binary data)",f.placeholder="Encrypted/Decrypted file content will appear here",h.style.display="inline",p.style.display="none",u.textContent=`File: ${o} (${P(e.size)})`;const t=new FileReader;t.onload=e=>{const t=e.target.result,n=new Uint8Array(t);c.value="_BINARY_DATA_",c._binaryData=n,r()},t.readAsArrayBuffer(e)}})),s.appendChild(c);const y=createElement("div",{style:{display:"flex",justifyContent:"space-between"}});y.appendChild(p),y.appendChild(h),y.appendChild(d),s.appendChild(y),s.appendChild(u),s.appendChild(m),a.appendChild(s);const g=createElement("div",{style:{flex:"1",marginLeft:"5px"}}),f=createElement("textarea",{placeholder:"The result will appear here",disabled:!0,rows:"10",class:"crypt-textarea"}),b=createElement("div",{style:{marginTop:"5px",fontSize:"12px",color:"#666"}}),v=createElement("button",{onclick:()=>{navigator.clipboard.writeText(f.value)},disabled:!0},"Copy Result"),w=createElement("button",{onclick:()=>{if(l&&f._binaryData){let e=o;if(e.includes(".")){const t=e.split(".");t.pop();const n=t.join(".");e=e.endsWith(".enc")?n:`${e}.enc`}else e=`${e}.enc`;const t=new Blob([f._binaryData],{type:i}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}else{const e=new Blob([f.value],{type:"text/plain"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="result.txt",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}},disabled:!0},"Download");g.appendChild(f);const E=createElement("div",{style:{display:"flex",justifyContent:"space-between"}});E.appendChild(w),E.appendChild(v),g.appendChild(E),g.appendChild(b),a.appendChild(g),n.appendChild(a);const C=createElement("div",{style:{display:"flex",alignItems:"center",flexWrap:"wrap"}}),x=createElement("label",{style:{margin:"var(--margin-small)"}},"Password Length: "),S=createElement("input",{type:"range",min:"16",max:"200",value:"24",oninput:e=>{k.textContent=e.target.value}}),k=createElement("span",{},S.value);x.appendChild(S),x.appendChild(k),C.appendChild(x);const I=createElement("button",{onclick:()=>{const e=parseInt(S.value,10);R.value=F(e),r()}},"Generate"),D=createElement("input",{type:"file",style:{display:"none"}}),T=createElement("button",{onclick:()=>D.click()},"Attach");D.addEventListener("change",(async()=>{const e=D.files[0];if(e){const t=await readFileAsync(e);R.value=t.content.trim(),r(),D.value=""}}));const A=createElement("button",{disabled:!0},"Encrypt"),L=createElement("button",{disabled:!0},"Decrypt");C.appendChild(I),C.appendChild(T),C.appendChild(D),C.appendChild(A),C.appendChild(L),n.appendChild(C);const M=createElement("div",{style:{display:"flex",alignItems:"center"}}),R=createElement("input",{type:"text",placeholder:"Enter encryption key",class:"crypt-textarea",style:{flex:"1"}}),N=createElement("button",{onclick:()=>{navigator.clipboard.writeText(R.value)},disabled:!0},"Copy Key");M.appendChild(R),M.appendChild(N),n.appendChild(M),e.appendChild(n);const P=e=>e<1024?e+" bytes":e<1048576?(e/1024).toFixed(2)+" KB":(e/1048576).toFixed(2)+" MB",F=e=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ¡¢£¤¥¦§¨©«®¯°±²³´µ¶·¸¹º¼½¾¿€©®™×÷ƒ∑∆∂∞≈≠≡≤≥⊂⊃∈∉√π∞∩∪⊥∧∨∩≈⊕⊗∫";let n="";for(let a=0;a<e;a++)n+=t.charAt(Math.floor(Math.random()*t.length));return n};c.addEventListener("input",r),R.addEventListener("input",r),m.addEventListener("change",r),f.addEventListener("input",r),A.onclick=async()=>{if(R.value.length>=16)try{if(l&&c._binaryData){const e=c._binaryData,[t,n,a]=await(async(e,t)=>{const n=crypto.getRandomValues(new Uint8Array(16)),a=crypto.getRandomValues(new Uint8Array(12)),l=await deriveKey(t,n),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:a},l,e);return[new Uint8Array(o),a,n]})(e,R.value);f._binaryData=(e=>{const t=e.reduce(((e,t)=>e+t.length),0),n=new Uint8Array(t);let a=0;return e.forEach((e=>{n.set(e,a),a+=e.length})),n})([a,n,t]),f.value="_ENCRYPTED_BINARY_DATA_",f.disabled=!0,b.textContent=`Encrypted: ${P(f._binaryData.length)} (ready to download)`}else{f._binaryData=null;const{encryptedText:e,iv:t,salt:n}=await encryptText(c.value,R.value);f.value=e,f.iv=t,f.salt=n,f.disabled=!0,b.textContent=""}r()}catch(e){b.textContent=`Encryption failed: ${e.message}`}else b.textContent="Please enter an encryption key of minimum 16 characters."},L.onclick=async()=>{if(R.value.length>=16)try{if(l&&c._binaryData){const e=c._binaryData,t=e.slice(0,16),n=e.slice(16,28),a=e.slice(28),l=await(async(e,t,n,a)=>{const l=await deriveKey(t,a),o=await crypto.subtle.decrypt({name:"AES-GCM",iv:n},l,e);return new Uint8Array(o)})(a,R.value,n,t);f._binaryData=l,f.value="_DECRYPTED_BINARY_DATA_",f.disabled=!0,b.textContent=`Decrypted: ${P(l.length)} (ready to download)`,r()}else try{const e=await decryptText(c.value,R.value);f.value=e,b.textContent="",r()}catch(e){b.textContent=`Decryption failed: ${e.message}`}}catch(e){b.textContent=`Decryption failed: ${e.message}. Make sure the input is valid and the encryption key is correct.`}else b.textContent="Please enter an encryption key (minimum 16 characters)."},r()},renderReminderChannel=(e,t)=>{e.innerHTML="";const n=e=>{const{r:t,g:n,b:a}=(e=>{if((e=e.trim().toLowerCase()).startsWith("#")){let t=e.slice(1);return[3,4].includes(t.length)&&(t=t.split("").map((e=>e+e)).join("")),{r:parseInt(t.substring(0,2),16),g:parseInt(t.substring(2,4),16),b:parseInt(t.substring(4,6),16)}}if(e.startsWith("rgb")){const t=e.match(/(\d+)/g)||[];return{r:+t[0]||0,g:+t[1]||0,b:+t[2]||0}}return{r:255,g:255,b:255}})(e),l=e=>(e/=255)<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4);return.2126*l(t)+.7152*l(n)+.0722*l(a)>.179?"#000000":"#ffffff"};reminders[t.id]=reminders[t.id]||[];const a=createElement("div"),l=createElement("form",{onsubmit:e=>{e.preventDefault(),reminders[t.id].push({date:o.value||null,text:i.value,color:r.value}),o.value="",i.value="",s()},style:{display:"flex",flexWrap:"wrap",alignItems:"center"}}),o=createElement("input",{type:"datetime-local",style:{colorScheme:"dark"}}),i=createElement("input",{type:"text",placeholder:"Reminder text",required:!0}),r=createElement("input",{type:"color",value:"#007bff",style:{colorScheme:"dark"}});l.append(o,i,r,createElement("button",{type:"submit"},"Add Reminder")),e.appendChild(l),e.appendChild(a);const s=()=>{a.innerHTML="",reminders[t.id].forEach(((e,l)=>{const o=createElement("div",{class:"reminder-container",style:{backgroundColor:e.color,color:n(e.color)}});e.date&&o.appendChild(createElement("div",{},new Date(e.date).toLocaleString())),o.appendChild(createElement("div",{},e.text)),o.appendChild(createElement("button",{style:{position:"absolute",top:"0",right:"0",padding:"2px 8px",border:"none",background:"transparent",color:"inherit",cursor:"pointer",fontSize:"14px",borderRadius:"0 4px 0 4px"},onclick:()=>{reminders[t.id].splice(l,1),s()}},"×")),a.appendChild(o)}))};s()};let autoSaveIntervalId=null,isAutoSaveEnabled="true"===localStorage.getItem("autoSaveEnabled"),autoSaveInterval=parseInt(localStorage.getItem("autoSaveInterval"),10)||3e4,lastSaveTimestamp=Date.now(),countdownIntervalId=null;async function deriveKey(e,t){const n=new TextEncoder,a=await crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e4,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}const arrayToHex=e=>Array.from(e).map((e=>("0"+e.toString(16)).slice(-2))).join(""),hexToArray=e=>{const t=e.length/2,n=new Uint8Array(t);for(let a=0;a<t;a++)n[a]=parseInt(e.substring(2*a,2*a+2),16);return n},encryptText=async(e,t)=>{const n=crypto.getRandomValues(new Uint8Array(16)),a=crypto.getRandomValues(new Uint8Array(12)),l=(new TextEncoder).encode(e),o=await deriveKey(t,n),i=await crypto.subtle.encrypt({name:"AES-GCM",iv:a},o,l);return{encryptedText:arrayToHex(n)+":"+arrayToHex(a)+":"+arrayToHex(new Uint8Array(i)),iv:arrayToHex(a),salt:arrayToHex(n)}},decryptText=async(e,t)=>{const[n,a,l]=e.split(":");if(!n||!a||!l)throw new Error("Invalid encrypted message format");const o=hexToArray(n),i=hexToArray(a),r=hexToArray(l),s=await deriveKey(t,o),c=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},s,r);return(new TextDecoder).decode(c)},saveData=async e=>{const t={chatMessages:chatMessages,flashcards:flashcards,codeData:window.codeData,reminders:reminders,categories:channelCategories,whiteboardData:window.whiteboardData},n={encrypted:!1,data:t,whiteboardData:window.whiteboardData};if(e)try{const a=JSON.stringify(t),l=await encryptText(a,e);n.encrypted=!0,n.data=l,localStorage.setItem("isEncrypted","true")}catch(e){alert("Failed to encrypt data. Saving unencrypted."),n.encrypted=!1,n.data=t,localStorage.setItem("isEncrypted","false")}else localStorage.setItem("isEncrypted","false");localStorage.setItem("appData",JSON.stringify(n)),lastSaveTimestamp=Date.now()},startAutoSave=()=>{stopAutoSave(),autoSaveIntervalId=setInterval((()=>saveData("")),autoSaveInterval)},stopAutoSave=()=>{autoSaveIntervalId&&(clearInterval(autoSaveIntervalId),autoSaveIntervalId=null)},startCountdownDisplay=e=>{stopCountdownDisplay(),updateCountdownDisplay(e),countdownIntervalId=setInterval((()=>updateCountdownDisplay(e)),100)},stopCountdownDisplay=()=>{countdownIntervalId&&(clearInterval(countdownIntervalId),countdownIntervalId=null)},updateCountdownDisplay=e=>{if(isAutoSaveEnabled){const t=Date.now()-lastSaveTimestamp,n=Math.max(0,autoSaveInterval-t);e.textContent=`Auto-save in: ${(n/1e3).toFixed(1)}s`}else e.textContent="Auto-save in: --s"},renderFilesChannel=(e,t)=>{e.innerHTML="";let n=[],a=!1,l=null,o=null,i="",r=[],s=0;const c=createElement("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap"}}),d=createElement("div",{style:{width:"100%",display:"flex",alignItems:"center"}}),p=createElement("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"center"}}),h=createElement("span",{style:{fontSize:"12px",color:"#666",margin:"var(--margin-small)",display:"block"}},"Supported: JPG, PNG, WebP, PDF"),u=createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",alignItems:"center",marginTop:"20px"}}),m=createElement("div",{style:{position:"relative",width:"100%",height:"calc(100vh - 200px)",display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"}}),y=createElement("button",{style:{position:"absolute",left:"10px",top:"50%",transform:"translateY(-50%)",fontSize:"24px",border:"none",display:"none"},disabled:!0},"←"),g=createElement("button",{style:{position:"absolute",right:"10px",top:"50%",transform:"translateY(-50%)",fontSize:"24px",border:"none",display:"none",alignItems:"center"},disabled:!0},"→"),f=createElement("img",{style:{width:"100%",height:"auto",maxWidth:"100%",maxHeight:"100%",objectFit:"contain",display:"none"}}),b=createElement("div",{style:{margin:"var(--margin-small)",display:"none",width:"300px"}}),v=createElement("label",{style:{marginRight:"10px"}},"Threshold: 128"),w=createElement("input",{type:"range",min:"64",max:"128",value:"120",style:{width:"200px"}});w.addEventListener("touchstart",(e=>{e.stopPropagation()})),w.addEventListener("touchmove",(e=>{e.stopPropagation()}),{passive:!0}),e.append(c,h,d,u),u.append(m,b),m.append(y,f,g),b.append(v,w);const E=createElement("input",{type:"file",accept:".jpg,.jpeg,.png,.webp,.pdf,.svg",multiple:!0,style:{display:"none"},onchange:function(e){n=Array.from(e.target.files),a=!1,k.disabled=!0,I.disabled=!0,T.disabled=!0,l=null,o=null,i="",D.value="",E.value="",function(){if(S.innerHTML="",!n.length)return S.innerHTML='<option value="">Select files to choose conversion</option>',S.disabled=!0,k.disabled=!0,void A();S.disabled=!1;let e=!1;for(const[t,a]of Object.entries(x)){if(n.every((e=>{const t="."+e.name.split(".").pop().toLowerCase();return a.formats.includes(t)}))){const n=createElement("option",{value:t},a.label);S.appendChild(n),e=!0}}if(e){const e=S.value,t=x[e];k.disabled=!a&&(!t||n.length>1&&!t.multiFile)}else S.innerHTML='<option value="">No conversions available</option>',S.disabled=!0,k.disabled=!0;A()}(),r=[],s=0,R()}}),C=createElement("button",{onclick:()=>E.click()},"Import File(s)"),x={base64:{label:"Image to Base64",formats:".jpg,.jpeg,.png,.webp,.svg",supports:"JPG, PNG, WebP, SVG",multiFile:!1},pdfToImages:{label:"PDF to Images",formats:".pdf",supports:"PDF",multiFile:!1},pdfToImagesHD:{label:"PDF to Images HD",formats:".pdf",supports:"PDF",multiFile:!1},pdfToImagesInverted:{label:"PDF to Images (Inverted)",formats:".pdf",supports:"PDF",multiFile:!1},pdfToImagesHDInverted:{label:"PDF to Images HD (Inverted)",formats:".pdf",supports:"PDF",multiFile:!1},scanImages:{label:"Scan Images",formats:".jpg,.jpeg,.png,.webp",supports:"JPG, PNG, WebP",multiFile:!0},imagesToPdf:{label:"Image(s) to PDF",formats:".jpg,.jpeg,.png,.webp",supports:"JPG, PNG, WebP",multiFile:!0},imagesToSvg:{label:"Image(s) to SVG",formats:".jpg,.jpeg,.png,.webp",supports:"JPG, PNG, WebP",multiFile:!0}},S=createElement("select",{style:{margin:"var(--margin-small)"},onchange:()=>{if(A(),n.length){const e=S.value,t=x[e];k.disabled=!a&&(!t||n.length>1&&!t.multiFile)}}});S.innerHTML='<option value="">Select files to convert</option>',S.disabled=!0;const k=createElement("button",{disabled:!0,onclick:async function(){if(!n.length)return void alert("Please select at least one file.");const e=S.value;if(!e)return void alert("Please select a valid conversion option.");const t=x[e];if(n.length>1&&!t.multiFile)return void alert("This conversion option does not support multiple files.");l=null,o=null,i="",D.value="",I.disabled=!0,T.disabled=!0;try{switch(e){case"base64":await async function(){const e=await P(n[0]);l="text",o=e.content,i=`${n[0].name.split(".").slice(0,-1).join(".")||"input"}_base64.txt`,D.value=o,I.disabled=!1,T.disabled=!1}();break;case"pdfToImages":await L(!1,2);break;case"pdfToImagesHD":await L(!1,3);break;case"pdfToImagesInverted":await L(!0,2);break;case"pdfToImagesHDInverted":await L(!0,3);break;case"scanImages":await async function(){if(!window.JSZip)throw new Error("JSZip library is not loaded.");r=[],s=0;for(let e=0;e<n.length;e++){const t=n[e],a=await P(t),l=await N(a.content),o=document.createElement("canvas"),i=o.getContext("2d"),s=.6;o.width=l.width*s,o.height=l.height*s,i.drawImage(l,0,0,o.width,o.height),M(i,o.width,o.height),r.push({previewDataUrl:o.toDataURL("image/png"),originalDataUrl:a.content,threshold:120})}R(),l="blob",o=null,i="scanned_images.zip",D.value="Adjust threshold and click Download to get scanned images",I.disabled=!1,T.disabled=!0}();break;case"imagesToPdf":await async function(){const e=window.jspdf.jsPDF;if(!e)throw new Error("jsPDF library is not loaded.");const t=.1,a=new e({format:[1,1]});for(let e=0;e<n.length;e++){const l=n[e];let o=await P(l).then((e=>e.content)),i=o.split(";")[0].split("/")[1].toUpperCase();if("WEBP"===i){const e=await N(o),t=document.createElement("canvas");t.width=e.width,t.height=e.height;t.getContext("2d").drawImage(e,0,0),o=t.toDataURL("image/png"),i="PNG"}const r=await N(o),s=r.width*t,c=r.height*t;e>0?a.addPage([s,c]):(a.internal.pageSize.width=s,a.internal.pageSize.height=c),a.setPage(e+1),a.addImage(o,i,0,0,s,c)}const r=a.output("blob");l="blob",o=r,i="images_to_pdf.pdf",D.value="PDF ready for download",I.disabled=!1,T.disabled=!0}();break;case"imagesToSvg":await async function(){const e=[];for(const t of n){const n=await P(t),a=await N(n.content),l=16,o=Math.min(l/a.width,l/a.height,1),i=document.createElement("canvas");i.width=Math.floor(a.width*o),i.height=Math.floor(a.height*o);const r=i.getContext("2d");r.drawImage(a,0,0,i.width,i.height);const s=j(r.getImageData(0,0,i.width,i.height),i.width,i.height);e.push({name:`${t.name.split(".").slice(0,-1).join(".")||"image"}.svg`,content:s})}if(1===e.length)l="text",o=e[0].content,i=e[0].name,D.value=o,I.disabled=!1,T.disabled=!1;else{const t=window.JSZip;if(!t)throw new Error("JSZip library is not loaded.");const n=new t;e.forEach((e=>{n.file(e.name,e.content)}));const a=await n.generateAsync({type:"blob"});l="blob",o=a,i="images_to_svg.zip",D.value="ZIP file with SVGs ready for download",I.disabled=!1,T.disabled=!0}}();break;default:alert("Unknown conversion option.")}a=!0,k.disabled=!0}catch(e){alert(`Conversion failed: ${e.message}`)}}},"Convert"),I=createElement("button",{disabled:!0,onclick:async()=>{if("blob"===l||o)if("text"===l)F("data:text/plain;charset=utf-8,"+encodeURIComponent(o),i);else if("scanImages"===S.value)try{I.disabled=!0,I.textContent="Processing...";const e=window.JSZip;if(!e)throw new Error("JSZip library is not loaded.");const t=new e;for(let e=0;e<r.length;e++){const a=n[e],l=await N(r[e].originalDataUrl),o=document.createElement("canvas"),i=o.getContext("2d");o.width=l.width,o.height=l.height,i.drawImage(l,0,0),M(i,o.width,o.height,r[e].threshold);const s=await new Promise((e=>o.toBlob(e,"image/png",1))),c=await s.arrayBuffer();t.file(`Scanned_${a.name.split(".").slice(0,-1).join(".")||"image"}_${e+1}.png`,c)}const a=await t.generateAsync({type:"blob"}),l=URL.createObjectURL(a);F(l,i),setTimeout((()=>URL.revokeObjectURL(l)),100),D.value="ZIP file with scanned images ready for download",I.disabled=!1,I.textContent="Download"}catch(e){alert(`Download failed: ${e.message}`),D.value="Download failed",I.disabled=!1,I.textContent="Download"}else if("blob"===l&&o){const e=URL.createObjectURL(o);F(e,i),setTimeout((()=>URL.revokeObjectURL(e)),100)}}},"Download"),D=createElement("input",{type:"text",placeholder:"Converted output will appear here...",readonly:!0,style:{flexGrow:1,marginRight:"5px"}}),T=createElement("button",{disabled:!0,onclick:()=>{D.value&&navigator.clipboard.writeText(D.value)}},"Copy");function A(){const e=x[S.value];h.textContent=e?`Supported: ${e.supports}`:"Supported: JPG, PNG, WebP, PDF"}async function L(e,t){const a=await async function(e,t=!1,n=2){if(!window.pdfjsLib||!window.JSZip)throw new Error("Required libraries (pdf.js or JSZip) are not loaded.");const a=window.pdfjsLib,l=window.JSZip,o=await e.arrayBuffer(),i=await a.getDocument({data:o}).promise,r=new l;for(let e=1;e<=i.numPages;e++){const a=await i.getPage(e),l=a.getViewport({scale:n}),o=document.createElement("canvas"),s=o.getContext("2d");o.width=l.width,o.height=l.height;const c={canvasContext:s,viewport:l};if(await a.render(c).promise,t){const e=s.getImageData(0,0,o.width,o.height),t=e.data;for(let e=0;e<t.length;e+=4)t[e]=255-t[e],t[e+1]=255-t[e+1],t[e+2]=255-t[e+2];s.putImageData(e,0,0)}const d=await new Promise((e=>o.toBlob(e,"image/png",1))),p=await d.arrayBuffer();r.file(`Page_${e}.png`,p)}return await r.generateAsync({type:"blob"})}(n[0],e,t);l="blob",o=a,i=`${n[0].name.split(".").slice(0,-1).join(".")||"input"}_pages.zip`,D.value="ZIP file ready for download",I.disabled=!1,T.disabled=!0}function M(e,t,n,a=120){const l=e.getImageData(0,0,t,n),o=l.data,i=o.length,r=a/128,s=new Float32Array(t*n);for(let e=0,n=0;e<i;e+=4,n++){const a=.2989*o[e]+.587*o[e+1]+.114*o[e+2],l=n%t,i=Math.floor(n/t);s[n]=a+(l>0?s[n-1]:0)+(i>0?s[n-t]:0)-(l>0&&i>0?s[n-t-1]:0)}for(let e=0;e<n;e++){const a=Math.max(0,e-15),l=Math.min(n-1,e+15);for(let n=0;n<t;n++){const i=e*t+n<<2,c=.2989*o[i]+.587*o[i+1]+.114*o[i+2],d=Math.max(0,n-15),p=Math.min(t-1,n+15),h=d>0&&a>0?s[(a-1)*t+(d-1)]:0,u=a>0?s[(a-1)*t+p]:0,m=d>0?s[l*t+(d-1)]:0,y=c<(s[l*t+p]-u-m+h)/((p-d+1)*(l-a+1))*r?0:255;o[i]=o[i+1]=o[i+2]=y}}const c=new Uint8ClampedArray(o),d=[1,2,1,2,4,2,1,2,1];for(let e=1;e<n-1;e++)for(let n=1;n<t-1;n++){let a=0,l=0,i=0;for(let r=-1;r<=1;r++)for(let s=-1;s<=1;s++){const c=(e+r)*t+(n+s)<<2,p=d[3*(r+1)+(s+1)];a+=o[c]*p,l+=o[c+1]*p,i+=o[c+2]*p}const r=e*t+n<<2;c[r]=a/16,c[r+1]=l/16,c[r+2]=i/16}for(let e=0;e<i;e++)o[e]=c[e];e.putImageData(l,0,0),e.filter="contrast(2.0)";const p=document.createElement("canvas");p.width=t,p.height=n,p.getContext("2d").putImageData(l,0,0),e.drawImage(p,0,0),e.filter="none"}function R(){if(!r.length)return f.style.display="none",y.style.display="none",g.style.display="none",void(b.style.display="none");f.src=r[s].previewDataUrl,f.style.display="block",y.style.display="block",g.style.display="block",y.disabled=0===s,g.disabled=s===r.length-1,b.style.display="block",v.textContent=`Threshold: ${w.value}`}y.onclick=()=>{s>0&&(s--,R())},g.onclick=()=>{s<r.length-1&&(s++,R())},w.oninput=async()=>{const e=parseInt(w.value);v.textContent=`Threshold: ${e}`;const t=r[s],n=document.createElement("canvas"),a=n.getContext("2d"),l=await N(t.originalDataUrl);n.width=.6*l.width,n.height=.6*l.height,a.drawImage(l,0,0,n.width,n.height),M(a,n.width,n.height,e),f.src=n.toDataURL("image/png"),r[s].previewDataUrl=f.src,r[s].threshold=e};const N=e=>new Promise(((t,n)=>{const a=new Image;a.onload=()=>t(a),a.onerror=n,a.src=e})),P=e=>new Promise(((t,n)=>{const a=new FileReader;a.onload=()=>t({content:a.result}),a.onerror=n,a.readAsDataURL(e)})),F=(e,t)=>{const n=createElement("a",{href:e,download:t});document.body.appendChild(n),n.click(),document.body.removeChild(n)};function j(e,t,n,a=1){let l=`<svg width="${t*a}" height="${n*a}" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">\n`;for(let o=0;o<n;o++)for(let n=0;n<t;n++){const i=4*(o*t+n);l+=`<rect x="${n*a}" y="${o*a}" width="${a}" height="${a}" fill="${`rgba(${e.data[i]}, ${e.data[i+1]}, ${e.data[i+2]}, ${e.data[i+3]/255})`}" />\n`}return l+="</svg>",l}p.append(E,C,S,k,I),c.append(p),d.append(D,T)},renderSettingsChannel=(e,t)=>{e.innerHTML="";const n=createElement("div",{style:{display:"flex",flexWrap:"wrap",justifyContent:"flex-end"}}),a=createElement("button",{onclick:async()=>{if(a.disabled)return;a.disabled=!0;const e=r.value.trim();await saveData(e),r.value="";const t=a.textContent;a.textContent="Saving...",w(),setTimeout((()=>{a.textContent=t,a.disabled=!1}),500)}},"Save data"),l=createElement("button",{class:"remove-btn"},"Erase memory");(()=>{let e=!1;l.addEventListener("click",(t=>{t.preventDefault(),e?(l.textContent="Erasing...",l.disabled=!0,(()=>{localStorage.removeItem("appData"),localStorage.removeItem("autoSaveEnabled"),localStorage.removeItem("autoSaveInterval"),localStorage.removeItem("isEncrypted"),Object.keys(chatMessages).forEach((e=>delete chatMessages[e])),Object.keys(flashcards).forEach((e=>delete flashcards[e])),Object.keys(reminders).forEach((e=>delete reminders[e])),window.whiteboardData={},window.codeData={};const e=channelCategories.findIndex((e=>"Functions"===e.name));-1!==e&&channelCategories.splice(e,1),renderSidebar(),isAutoSaveEnabled=!1,h.checked=!1,autoSaveInterval=3e4,m.value=autoSaveInterval,y.textContent=`Interval: ${autoSaveInterval/1e3}s`,stopAutoSave(),stopCountdownDisplay(),v.textContent="Auto-save in: --s",w()})(),setTimeout((()=>{l.textContent="Erase memory",e=!1,l.disabled=!1}),500)):(l.textContent="Are you sure?",e=!0,l.disabled=!0,setTimeout((()=>l.disabled=!1),500))})),document.addEventListener("click",(t=>{t.target!==l&&e&&!l.disabled&&(l.textContent="Erase memory",e=!1)}))})(),n.appendChild(a),n.appendChild(l),e.appendChild(n);const o=createElement("div",{style:{display:"flex",alignItems:"center",flexWrap:"wrap"}}),i=createElement("label",{style:{margin:"var(--margin-small)"}},"Token (Encryption Key): "),r=createElement("input",{type:"text",placeholder:"Enter token for encrypted save",style:{flex:"1",minWidth:"150px",marginRight:"var(--margin-small)"}}),s=createElement("button",{onclick:()=>c.click(),style:{marginRight:"var(--margin-small)"}},"Attach"),c=createElement("input",{type:"file",style:{display:"none"}});c.addEventListener("change",(async()=>{const e=c.files[0];if(e){const t=await readFileAsync(e);r.value=t.content.trim(),c.value=""}})),o.appendChild(i),o.appendChild(r),o.appendChild(s),o.appendChild(c),e.appendChild(o);const d=createElement("div",{style:{display:"flex",alignItems:"center",margin:"var(--margin-small)"}}),p=createElement("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"center"}});e.appendChild(d),d.appendChild(p);const h=createElement("input",{type:"checkbox",checked:isAutoSaveEnabled,onchange:e=>{isAutoSaveEnabled=e.target.checked,localStorage.setItem("autoSaveEnabled",isAutoSaveEnabled),isAutoSaveEnabled?(saveData(""),startAutoSave(),startCountdownDisplay(v)):(stopAutoSave(),stopCountdownDisplay(),v.textContent="Auto-save in: --s")}}),u=createElement("label",{style:{display:"flex",alignItems:"center"}},"Auto Save: ",h),m=createElement("input",{style:{margin:"var(--margin-small)"},type:"range",min:"1000",max:"60000",step:"1000",value:autoSaveInterval,oninput:e=>{autoSaveInterval=parseInt(e.target.value,10),localStorage.setItem("autoSaveInterval",autoSaveInterval),y.textContent=`Interval: ${autoSaveInterval/1e3}s`,isAutoSaveEnabled&&(lastSaveTimestamp=Date.now(),startAutoSave(),startCountdownDisplay(v))}}),y=createElement("span",{},`Interval: ${autoSaveInterval/1e3}s`),g=createElement("div",{style:{display:"flex",alignItems:"center"}},m,y);p.appendChild(u),p.appendChild(g);const f=createElement("div",{style:{margin:"var(--margin-small)",color:"var(--color-text-muted)"}}),b=createElement("div"),v=createElement("div",{style:{margin:"var(--margin-small)",color:"var(--color-text-muted)"}},"Auto-save in: --s"),w=()=>{const e={chatMessages:chatMessages,flashcards:flashcards,whiteboardData:window.whiteboardData,codeData:window.codeData,reminders:reminders},t=JSON.stringify(e),n=new Blob([t]).size,a=5242880,l=n/a*100;b.style.width=l+"%",f.textContent=`Memory used: ${(n/1048576).toFixed(2)} MB (${l.toFixed(1)}% of ${5..toFixed(2)} MB)`};f.appendChild(b),e.appendChild(f),e.appendChild(v),isAutoSaveEnabled&&startCountdownDisplay(v),w()},loadSavedData=async()=>{const e=localStorage.getItem("appData"),t="true"===localStorage.getItem("isEncrypted");if(e)try{const n=JSON.parse(e);if(window.whiteboardData=n.whiteboardData||{},t)return void await showDecryptModal();{const e=n.data;Object.assign(chatMessages,e.chatMessages||{}),Object.assign(flashcards,e.flashcards||{}),window.codeData=e.codeData||{},Object.assign(reminders,e.reminders||{}),e.categories&&channelCategories.splice(0,channelCategories.length,...e.categories)}}catch(e){}isAutoSaveEnabled&&startAutoSave(),renderSidebar(),channelCategories.length&&channelCategories[0].channels.length&&selectChannel(channelCategories[0].channels[0])},showDecryptModal=async()=>{const e=localStorage.getItem("appData"),t="true"===localStorage.getItem("isEncrypted");if(!e||!t)return;const n=createElement("div",{style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"black",display:"flex",justifyContent:"center",alignItems:"center",zIndex:"1000"}}),a=createElement("div",{style:{padding:"var(--padding-small)",borderRadius:"var(--border-radius-circle)",border:"2px solid var(--color-primary)",display:"flex",flexDirection:"column",alignItems:"center",width:"90%",maxWidth:"400px",color:"var(--color-text-light)"}}),l=createElement("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"center",gap:"var(--margin-small)",width:"100%"}}),o=createElement("input",{type:"text",placeholder:"Enter encryption token"}),i=createElement("input",{type:"file",style:{display:"none"}}),r=createElement("button",{onclick:()=>i.click()},"Attach");i.addEventListener("change",(async()=>{const e=i.files[0];if(e){const t=await readFileAsync(e);o.value=t.content.trim(),s.disabled=!o.value.trim(),c.style.display="none",i.value=""}}));const s=createElement("button",{onclick:async()=>{const t=o.value.trim();if(!t)return c.style.display="block",void(c.textContent="Please enter a token.");try{const a=JSON.parse(e),l=await decryptText(a.data.encryptedText,t),o=JSON.parse(l);Object.assign(chatMessages,o.chatMessages||{}),Object.assign(flashcards,o.flashcards||{}),window.codeData=o.codeData||{},Object.assign(reminders,o.reminders||{}),o.categories&&channelCategories.splice(0,channelCategories.length,...o.categories),window.whiteboardData=a.whiteboardData||{},document.body.removeChild(n),renderSidebar(),channelCategories.length&&channelCategories[0].channels.length&&selectChannel(channelCategories[0].channels[0])}catch(e){c.style.display="block",c.textContent="Incorrect token. Please try again."}},disabled:!0},"Load Data");l.appendChild(o),l.appendChild(r),l.appendChild(i),l.appendChild(s);const c=createElement("div",{style:{color:"var(--color-text-muted)",fontSize:"var(--font-size-small)",margin:"var(--margin-small)",display:"none",textAlign:"center"}},"Incorrect token. Please try again."),d=createElement("button",{class:"button-aux",onclick:()=>{document.body.removeChild(n),renderSidebar(),channelCategories.length&&channelCategories[0].channels.length&&selectChannel(channelCategories[0].channels[0])}},"Skip");o.addEventListener("input",(()=>{s.disabled=!o.value.trim(),c.style.display="none"})),a.appendChild(l),a.appendChild(c),a.appendChild(d),n.appendChild(a),document.body.appendChild(n),o.focus()};document.addEventListener("DOMContentLoaded",(()=>{loadSavedData()}))})();