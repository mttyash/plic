(()=>{const createElement=(e,t={},...a)=>{const n=document.createElement(e);for(let[e,a]of Object.entries(t))"class"===e?n.className=a:"style"===e?Object.assign(n.style,a):e.startsWith("on")&&"function"==typeof a?n.addEventListener(e.slice(2).toLowerCase(),a):"checked"===e?n.checked=a:n.setAttribute(e,a);return a.forEach((e=>{"string"==typeof e?n.appendChild(document.createTextNode(e)):e&&n.appendChild(e)})),n},createToolbar=(e=[],t=[])=>{const a=createElement("div",{class:"toolbar"}),n=createElement("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"center"}});e.forEach((e=>n.appendChild(e)));const o=createElement("div",{style:{display:"flex",flexWrap:"wrap",marginLeft:"auto"}});return t.forEach((e=>o.appendChild(e))),a.appendChild(n),a.appendChild(o),a},channelCategories=[{name:"General",channels:[{id:"notes1",name:"Notes",type:"notes"}]},{name:"Learning",channels:[{id:"flashcard1",name:"Flashcards",type:"flashcard"},{id:"whiteboard1",name:"Whiteboard",type:"whiteboard"}]},{name:"Utilities",channels:[{id:"code1",name:"Code Runner",type:"code"},{id:"crypt1",name:"Crypt",type:"crypt"}]},{name:"Reminders",channels:[{id:"reminder1",name:"Reminders",type:"reminder"}]},{name:"Files",channels:[{id:"files1",name:"Files",type:"files"}]},{name:"Settings",channels:[{id:"settings",name:"Settings",type:"settings"}]}],chatMessages={},flashcards={},reminders={};window.whiteboardData=window.whiteboardData||{},window.codeData=window.codeData||{};const savedTheme=localStorage.getItem("customTheme");if(savedTheme)try{const e=JSON.parse(savedTheme);Object.entries(e).forEach((([e,t])=>{document.documentElement.style.setProperty(e,t)}))}catch(e){}const readFileAsync=e=>new Promise((t=>{const a=new FileReader;a.onload=a=>t({name:e.name,type:e.type,content:a.target.result}),e.type.startsWith("image/")||e.type.startsWith("video/")||e.type.startsWith("audio/")||"application/pdf"===e.type?a.readAsDataURL(e):a.readAsText(e)}));let activeChannelId=null;const selectChannel=e=>{activeChannelId=e.id,document.querySelectorAll(".channel-item").forEach((e=>{e.classList.toggle("active",e.getAttribute("data-channel-id")===activeChannelId)})),renderChannel(e)},renderSidebar=()=>{const e=document.querySelector(".sidebar");e.innerHTML="";const t=document.createElement("button");t.className="toggle-btn",t.textContent="☰",t.addEventListener("click",(()=>{e.classList.toggle("expanded")})),e.appendChild(t),channelCategories.forEach((t=>{const a=document.createElement("div");a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="flex-start",a.style.width="100%",a.style.gap="0.5rem";const n=document.createElement("div");n.className="channel-list",t.channels.forEach((e=>{const t=document.createElement("button");t.className="channel-item",t.textContent=e.name,t.dataset.channelId=e.id,t.dataset.channelType=e.type,e.id===activeChannelId&&t.classList.add("active"),t.addEventListener("contextmenu",(a=>{if(a.preventDefault(),"function"===e.type){t.textContent="Remove",t.title="Click to remove",t.classList.add("remove-btn");const a=n=>{n.stopPropagation();const o=channelCategories.find((e=>"Functions"===e.name));o&&(o.channels=o.channels.filter((t=>t.id!==e.id)),renderSidebar()),t.removeEventListener("click",a)},n=o=>{o.target!==t&&(t.classList.remove("remove-btn"),t.title="",t.textContent=e.name,t.removeEventListener("click",a),document.removeEventListener("click",n))};t.addEventListener("click",a),document.addEventListener("click",n)}})),t.addEventListener("click",(()=>{if("function"===e.type){const t=channelCategories.flatMap((e=>e.channels)).find((e=>"code"===e.type));t&&(window.codeData[t.id]=e.code,selectChannel(t))}else selectChannel(e)})),n.appendChild(t)})),a.appendChild(n),e.appendChild(a)}));const a=document.createElement("div");a.className="info",a.style.marginTop="auto",a.textContent="v1.50",e.appendChild(a)},renderChannel=e=>{const t=document.querySelector(".channel-content");t.innerHTML="";({notes:()=>renderNotesChannel(t,e),flashcard:()=>renderFlashcardChannel(t,e),whiteboard:()=>renderWhiteboardChannel(t,e),code:()=>renderCodeChannel(t,e),reminder:()=>renderReminderChannel(t,e),crypt:()=>renderCryptChannel(t,e),settings:()=>renderSettingsChannel(t,e),files:()=>renderFilesChannel(t,e)}[e.type]||(()=>{}))()},renderNotesChannel=(e,t)=>{e.innerHTML="";let a=!1;const n=chatMessages[t.id]||{html:"",files:[]};let o=[...n.files];const l=createButton("Read Mode",(()=>{a=!a,u.contentEditable=!a,l.classList.toggle("active",a)})),r=createElement("input",{type:"file",multiple:!0,style:{display:"none"}}),i=createButton("Attach File",(()=>r.click())),s=createButton("Linkify",(()=>{if(a)return;const e=window.getSelection(),t=e.toString().trim();if(!t)return;const n=prompt("Enter URL:");if(!n)return;const o=createElement("a",{href:n,target:"_blank",rel:"noopener noreferrer"},t),l=e.getRangeAt(0);l.deleteContents(),l.insertNode(o),e.collapseToEnd(),m()}),{disabled:!0}),c=createButton("Export",(()=>{const e={html:u.innerHTML,files:o},a=new Blob([JSON.stringify(e)],{type:"application/json"});createElement("a",{href:URL.createObjectURL(a),download:`${t.id}_notepad.json`}).click()})),d=createElement("input",{type:"file",accept:"application/json",style:{display:"none"}}),p=createButton("Import",(()=>d.click())),h=createToolbar([l,i,s],[c,p]);e.appendChild(h);const u=createElement("div",{class:"notepad-container",contentEditable:!0});function m(){chatMessages[t.id]={html:u.innerHTML,files:o}}u.innerHTML=n.html,e.appendChild(u),document.addEventListener("selectionchange",(()=>{s.disabled=a||!window.getSelection().toString().trim()})),r.addEventListener("change",(async()=>{const e=await Promise.all(Array.from(r.files).map(readFileAsync)),t=window.getSelection(),a=t.rangeCount?t.getRangeAt(0):null;e.forEach((e=>{o.push(e);const n=createAttachment(e);a?(a.insertNode(n),t.collapseToEnd()):u.appendChild(n)})),r.value="",u.focus(),m()})),u.addEventListener("input",m),u.addEventListener("keydown",(e=>{a||"Backspace"!==e.key&&"Delete"!==e.key||!window.getSelection().rangeCount||!window.getSelection().getRangeAt(0).startContainer.parentElement.closest(".attachment")||m()}))},createAttachment=e=>{const t=document.createElement("div");return t.className="attachment",t.style.margin="5px 0",e.type.startsWith("image/")?t.appendChild(createElement("img",{src:e.content,alt:e.name,style:{maxWidth:"300px"}})):"application/pdf"===e.type?t.appendChild(createElement("iframe",{src:e.content,title:e.name,style:{width:"300px",height:"500px"}})):t.appendChild(createElement("div",{styleA:{border:"1px solid #ccc",padding:"5px"}},e.name)),t},createButton=(e,t,a={})=>createElement("button",{type:"button",onclick:t,...a},e),renderFlashcardChannel=(e,t)=>{e.innerHTML="";const a=createElement("button",{type:"button",onclick:()=>m()},"Add Answer"),n=createElement("button",{type:"button",onclick:()=>p.requestSubmit()},"Add Flashcard"),o=createElement("button",{type:"button"},"Start Test"),l=createElement("button",{type:"button",onclick:()=>{const e=flashcards[t.id]||[],a=new Blob([JSON.stringify(e)],{type:"application/json"});createElement("a",{href:URL.createObjectURL(a),download:"flashcards.json"}).click()}},"Export"),r=createElement("input",{type:"file",accept:"application/json",style:{display:"none"},onchange:async e=>{const a=e.target.files[0];if(!a)return;const n=await readFileAsync(a);try{const e=JSON.parse(n.content);Array.isArray(e)&&(flashcards[t.id]=flashcards[t.id]||[],e.forEach((e=>{const a=flashcards[t.id].findIndex((t=>t.question===e.question));-1!==a?flashcards[t.id][a]=e:flashcards[t.id].push(e)})),f())}catch{}}}),i=createElement("button",{type:"button",onclick:()=>{r.value="",r.click()}},"Import"),s=createToolbar([a,n,o],[l,i]);e.appendChild(s);const c=createElement("div"),d=createElement("div"),p=createElement("form",{class:"flashcard-form",style:{display:"flex",flexWrap:"wrap",flexDirection:"column",marginRight:"10px"},onsubmit:e=>{e.preventDefault();const a=h.value.trim();if(!a)return;const n=Array.from(u.querySelectorAll(".answer-row")).map((e=>{const[t,a]=e.querySelectorAll("input");return a.value.trim()?{text:a.value,correct:t.checked}:null})).filter((e=>e));n.length&&(flashcards[t.id]=flashcards[t.id]||[],flashcards[t.id].push({question:a,answers:n}),h.value="",u.innerHTML="",m(),f())}}),h=createElement("input",{type:"text",placeholder:"Enter question here",required:!0});p.appendChild(h);const u=createElement("div",{id:"answers-container",style:{display:"flex",flexDirection:"column"}});p.appendChild(u);const m=(e="",t=!1)=>{const a=createElement("div",{class:"answer-row"});a.appendChild(createElement("input",{type:"checkbox",title:"Mark as correct answer",checked:t})),a.appendChild(createElement("input",{type:"text",placeholder:"Answer",required:!0,value:e,style:{flex:"1"}})),a.appendChild(createElement("button",{type:"button",onclick:()=>a.remove()},"Remove")),u.appendChild(a)};m(),d.appendChild(p);const g=createElement("div");d.appendChild(g);const y=createElement("div",{style:{display:"none"}});c.appendChild(d),c.appendChild(y),e.appendChild(c);const f=()=>{g.innerHTML="",(flashcards[t.id]=flashcards[t.id]||[]).forEach(((e,a)=>{const n=createElement("div",{class:"flashcard"}),o=createElement("p",{},"Q: "+e.question);n.appendChild(o);const l=createElement("div");e.answers.forEach((e=>{const t=createElement("div",{class:e.correct?"correct-highlight":"",style:{display:"flex",alignItems:"center"}}),a=createElement("input",{type:"checkbox",checked:e.correct,disabled:!0});t.appendChild(a),t.appendChild(document.createTextNode(e.text)),l.appendChild(t)})),n.appendChild(l);const r=createElement("div"),i=createElement("button",{type:"button",onclick:function(){if("Edit"===this.textContent){const t=createElement("input",{type:"text",value:e.question,style:{width:"100%"}});n.replaceChild(t,o);const a=createElement("div");e.answers.forEach((e=>{const t=createElement("div",{class:"answer-row",style:{display:"flex",alignItems:"center"}});t.appendChild(createElement("input",{type:"checkbox",checked:e.correct})),t.appendChild(createElement("input",{type:"text",value:e.text,style:{flex:"1"}})),a.appendChild(t)})),n.replaceChild(a,l);const i=createElement("button",{type:"button",onclick:()=>{const e=createElement("div",{class:"answer-row"});e.appendChild(createElement("input",{type:"checkbox"})),e.appendChild(createElement("input",{type:"text",placeholder:"New answer",style:{flex:"1"}})),a.appendChild(e)}},"Add Answer");r.insertBefore(i,this.nextSibling),this.textContent="Save"}else{const t=n.querySelector("input[type='text']");e.question=t.value;const a=[];n.querySelectorAll(".answer-row").forEach((e=>{const[t,n]=e.querySelectorAll("input");n.value.trim()&&a.push({text:n.value,correct:t.checked})})),e.answers=a;const o=r.querySelector("button:nth-child(3)");o&&"Add Answer"===o.textContent&&r.removeChild(o),f()}}},"Edit");r.appendChild(i),r.appendChild(createElement("button",{type:"button",onclick:()=>{flashcards[t.id].splice(a,1),f()}},"Remove")),n.appendChild(r),g.appendChild(n)})),o.disabled=!flashcards[t.id]?.length};f(),o.addEventListener("click",(()=>{d.style.display="none",b(y,t),y.style.display="block"}));const b=(e,t)=>{e.innerHTML="";const a=[...flashcards[t.id]||[]].sort((()=>Math.random()-.5));if(!a.length)return void(e.textContent="No flashcards available for testing.");const n=a.map((e=>{const t=e.answers.slice();for(let e=t.length-1;e>0;e--){const a=Math.floor(Math.random()*(e+1));[t[e],t[a]]=[t[a],t[e]]}return{question:e.question,answers:t}})),o=createElement("form",{onsubmit:e=>{e.preventDefault();let t=0;n.forEach(((e,a)=>{const n=Array.from(o.querySelectorAll(`input[name="card${a}"]:checked`)).map((e=>+e.value)),l=e.answers.map(((e,t)=>e.correct?t:null)).filter((e=>null!==e));n.sort().toString()===l.sort().toString()&&t++,o.querySelectorAll(`input[name="card${a}"]`).forEach((e=>{const t=+e.value;l.includes(t)?e.parentElement.classList.add("correct-highlight"):e.checked&&e.parentElement.classList.add("incorrect-highlight"),e.disabled=!0}))})),o.querySelector("button[type='submit']").disabled=!0,o.appendChild(createElement("div",{},`Your score: ${t} / ${n.length}`))}});n.forEach(((e,t)=>{const a=createElement("div");a.appendChild(createElement("p",{},"Q: "+e.question)),e.answers.forEach(((e,n)=>{const o=createElement("label",{style:{display:"flex",alignItems:"center"}});o.appendChild(createElement("input",{type:"checkbox",name:`card${t}`,value:n})),o.appendChild(document.createTextNode(e.text)),a.appendChild(o)})),o.appendChild(a)})),o.appendChild(createElement("button",{type:"submit"},"Submit Answers")),o.appendChild(createElement("button",{type:"button",onclick:()=>{e.style.display="none",d.style.display="block"}},"Back")),e.appendChild(o)}},renderWhiteboardChannel=(e,t)=>{e.innerHTML="";const a=e=>structuredClone(e),n=30,o="#696969",l=(e,t)=>{if(e.length<=2)return e;const a=x/t,[n,o]=e[0],[r,i]=e[e.length-1];let s=0,c=0;for(let t=1;t<e.length-1;t++){const[a,l]=e[t],d=Math.abs((i-o)*a-(r-n)*l+r*o-i*n)/Math.sqrt((i-o)**2+(r-n)**2);d>s&&(s=d,c=t)}if(s>a){const a=l(e.slice(0,c+1),t),n=l(e.slice(c),t);return a.slice(0,-1).concat(n)}return[e[0],e[e.length-1]]},r=(e,t)=>{let a=g*f%n,o=y*f%n;return a<0&&(a+=n),o<0&&(o+=n),{x:a+Math.round((e-a)/n)*n,y:o+Math.round((t-o)/n)*n}},i=(e,t,a,n)=>{for(let o=1;o<e.points.length;o++){const[l,r]=e.points[o-1],[i,s]=e.points[o],c=i-l,d=s-r,p=c*c+d*d;let h=0!==p?((t-l)*c+(a-r)*d)/p:-1;h=Math.max(0,Math.min(1,h));const u=l+h*c,m=r+h*d;if(Math.sqrt((t-u)**2+(a-m)**2)<=n+e.size/2)return!0}return!1},s=(e,t)=>{const a=({brush:[[3,0],[4,0],[2,1],[3,1],[4,1],[1,2],[2,2],[3,2],[1,3],[2,3],[0,4]],eraser:[[2,0],[3,0],[4,0],[1,1],[2,1],[3,1],[4,1],[0,2],[1,2],[2,2],[3,2],[4,2],[0,3],[1,3],[2,3],[3,3],[0,4],[1,4],[2,4]],pan:[[2,0],[2,1],[0,2],[1,2],[2,2],[3,2],[4,2],[2,3],[2,4]],snap:[[0,0],[1,0],[2,0],[3,0],[4,0],[0,1],[4,1],[0,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]],copy:[[1,0],[2,0],[3,0],[4,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[3,2],[4,2],[0,3],[3,3],[4,3],[0,4],[1,4],[2,4],[3,4]],copyDisabled:[[1,0],[2,0],[3,0],[4,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[3,2],[4,2],[0,3],[3,3],[4,3],[0,4],[1,4],[2,4],[3,4]],cut:[[0,0],[4,0],[1,1],[3,1],[2,2],[0,3],[1,3],[3,3],[4,3],[0,4],[1,4],[3,4],[4,4]],cutDisabled:[[0,0],[4,0],[1,1],[3,1],[2,2],[0,3],[1,3],[3,3],[4,3],[0,4],[1,4],[3,4],[4,4]],select:[[0,0],[2,0],[4,0],[0,2],[4,2],[0,4],[2,4],[4,4]],zoomIn:[[0,0],[1,0],[2,0],[3,0],[0,1],[3,1],[0,2],[3,2],[0,3],[1,3],[2,3],[3,3],[4,4]],zoomOut:[[0,0],[1,0],[2,0],[0,1],[2,1],[0,2],[1,2],[2,2],[3,3],[4,4]],attach:[[0,0],[1,0],[2,0],[0,1],[3,1],[0,2],[4,2],[0,3],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]],dotsVisibility:[[0,0],[2,0],[4,0],[0,2],[2,2],[4,2],[0,4],[2,4],[4,4]],undo:[[1,0],[0,1],[1,1],[2,1],[3,1],[4,1],[1,2],[4,2],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]],undoDisabled:[[1,0],[0,1],[1,1],[2,1],[3,1],[4,1],[1,2],[4,2],[4,3],[0,4],[1,4],[2,4],[3,4],[4,4]],redo:[[3,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[3,2],[0,3],[0,4],[1,4],[2,4],[3,4],[4,4]],redoDisabled:[[3,0],[0,1],[1,1],[2,1],[3,1],[4,1],[0,2],[3,2],[0,3],[0,4],[1,4],[2,4],[3,4],[4,4]]}[e]||[]).map((([e,a])=>`<rect x="${e}" y="${a}" width="1" height="1" fill="${t}"/>`)).join("");return`url('data:image/svg+xml,${encodeURIComponent(`<svg width="5" height="5" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">${a}</svg>`)}')`};let c,d,p,h,u,m,g,y,f,b,v,w="#fff",E=1,x=1,C=0,k=0,S=0,I=0,D=!0,T=!1,L=!1,A=!1,M=!1,R=null,P=null,j=0,F=0,U=null,$=!1,O=null,N=!1,B=null,J=!1,W=!1,_=!0,z=[],H=[];const q=e=>{z.push(e),z.length>10&&z.shift(),H=[],G()},G=()=>{ue.disabled=0===z.length,ue.style.backgroundImage=ue.disabled?s("undoDisabled","gray"):s("undo","white"),me.disabled=0===H.length,me.style.backgroundImage=me.disabled?s("redoDisabled","gray"):s("redo","white")},Z=(e,t,a)=>(D=T=L=A=!1,e=!e,V.style.backgroundImage=s("brush","white"),Q.style.backgroundImage=s("eraser","white"),ee.style.backgroundImage=s("pan","white"),se.style.backgroundImage=s("select","white"),t.style.backgroundImage=s(t.title.toLowerCase(),e?a:"white"),ce.disabled=!0,ce.style.backgroundImage=s("copyDisabled","gray"),de.disabled=!0,de.style.backgroundImage=s("cutDisabled","gray"),R=null,c.style.cursor=e&&t===se?"crosshair":"none",e),V=createElement("button",{class:"button-icn",onclick:()=>{D=Z(D,V,"#ff5100"),Ae()},style:{backgroundImage:s("brush","#ff5100")},title:"Brush"}),Y=createElement("input",{type:"range",min:"0.2",max:"5",step:"0.1",value:"0.4",onchange:e=>{x=+e.target.value,Ae()}}),K=createElement("input",{type:"color",value:"#ffffff",style:{colorScheme:"dark"},oninput:e=>{w=e.target.value,Ae()}}),X=createElement("input",{type:"range",min:"1",max:"20",value:"1",onchange:e=>{E=+e.target.value,Me()}}),Q=createElement("button",{class:"button-icn",onclick:()=>{T=Z(T,Q,"#ff0000"),Me()},style:{backgroundImage:s("eraser","white")},title:"Eraser"}),ee=createElement("button",{class:"button-icn",onclick:()=>{L=Z(L,ee,"#ff5100"),Ae()},style:{backgroundImage:s("pan","white")},title:"Pan"}),te=e=>createElement("button",{class:"button-icn",onclick:()=>{zoomTargetScale=Math.max(.1,Math.min(e?2*f:f/2,10));const t=c.width/2,a=c.height/2;g+=t/zoomTargetScale-t/f,y+=a/zoomTargetScale-a/f,f=zoomTargetScale,p.panZoom={offsetX:g,offsetY:y,scale:f},De(),Ae()},style:{backgroundImage:s(e?"zoomIn":"zoomOut","white")},title:e?"Zoom In":"Zoom Out"}),ae=te(!0),ne=te(!1),oe=createElement("button",{class:"button-icn",onclick:()=>{_=!_,oe.style.backgroundImage=s("dotsVisibility",_?"#ff5100":"white"),p.areDotsVisible=_,De(),Ae()},style:{backgroundImage:s("dotsVisibility","#ff5100")},title:"Toggle Dots"});let le="#12111b";const re=createElement("input",{type:"color",value:le,style:{colorScheme:"dark"},oninput:e=>{le=e.target.value,p.backgroundColor=le,Ae()}}),ie=createElement("button",{class:"button-icn",onclick:()=>{M=!M,ie.style.backgroundImage=s("snap",M?"#ff5100":"white")},style:{backgroundImage:s("snap","white")},title:"Snap"}),se=createElement("button",{class:"button-icn",onclick:()=>{A=Z(A,se,"#ff5100"),A||(P=null,R=null,Ae())},style:{backgroundImage:s("select","white")},title:"Select"}),ce=createElement("button",{class:"button-icn",onclick:()=>Ue(!1),disabled:!0,style:{backgroundImage:s("copyDisabled","gray")},title:"Copy"}),de=createElement("button",{class:"button-icn",onclick:()=>Ue(!0),disabled:!0,style:{backgroundImage:s("cutDisabled","gray")},title:"Cut"}),pe=createElement("input",{type:"file",accept:"image/*",style:{display:"none"},onchange:e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=()=>{const t=e.result,a=new Image;a.onload=()=>{const e=a.naturalWidth,n=a.naturalHeight,o=.25*(c.width/f),l=o*(n/e),r=Se(c.width/2)-o/2,i=Ie(c.height/2)-l/2;u.push({dataUrl:t,x:r,y:i,width:o,height:l}),m.push(a),Ae()},a.src=t},e.readAsDataURL(t)}pe.value=""}}),he=createElement("button",{class:"button-icn",onclick:()=>pe.click(),style:{backgroundImage:s("attach","white")},title:"Attach"}),ue=createElement("button",{class:"button-icn",onclick:()=>{if(0===z.length)return;const e=z.pop();switch(H.push(e),e.type){case"draw":case"erase":p.paths=e.prevState.paths,h=p.paths;break;case"copy":case"cut":case"paste":p.paths=e.prevState.paths,h=p.paths;break}G(),Ae()},disabled:!0,style:{backgroundImage:s("undoDisabled","gray")},title:"Undo"}),me=createElement("button",{class:"button-icn",onclick:()=>{if(0===H.length)return;const e=H.pop();switch(z.push(e),e.type){case"draw":case"erase":p.paths=e.nextState.paths,h=p.paths;break;case"copy":case"cut":case"paste":p.paths=e.nextState.paths,h=p.paths;break}G(),Ae()},disabled:!0,style:{backgroundImage:s("redoDisabled","gray")},title:"Redo"}),ge=createElement("button",{type:"button",onclick:()=>{try{const e={paths:Array.isArray(p.paths)?p.paths:[],images:Array.isArray(p.images)?p.images.map((e=>({dataUrl:"string"==typeof e.dataUrl?e.dataUrl:"",x:Number.isFinite(e.x)?e.x:0,y:Number.isFinite(e.y)?e.y:0,width:Number.isFinite(e.width)?e.width:0,height:Number.isFinite(e.height)?e.height:0}))):[],panZoom:p.panZoom||{offsetX:0,offsetY:0,scale:1},areDotsVisible:void 0===p.areDotsVisible||p.areDotsVisible,backgroundColor:p.backgroundColor||"#212121"},t=JSON.stringify(e);if(!t)throw new Error("JSON serialization failed");const a=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(a);createElement("a",{href:n,download:`whiteboard_${Date.now()}.json`}).click(),setTimeout((()=>URL.revokeObjectURL(n)),100)}catch(e){alert("Failed to export JSON: "+e.message)}}},"Export JSON"),ye=createElement("button",{type:"button",onclick:()=>{try{const{offsetX:e,offsetY:t,scale:a}=p.panZoom||{offsetX:0,offsetY:0,scale:1},n=p.paths||[],o=p.images||[];let l=1/0,r=1/0,i=-1/0,s=-1/0;n.forEach((e=>{!Array.isArray(e.points)||e.points.length<1||e.points.forEach((([e,t])=>{l=Math.min(l,e),r=Math.min(r,t),i=Math.max(i,e),s=Math.max(s,t)}))})),o.forEach((e=>{e.dataUrl&&(l=Math.min(l,e.x),r=Math.min(r,e.y),i=Math.max(i,e.x+(e.width||0)),s=Math.max(s,e.y+(e.height||0)))}));const c=10;l===1/0&&(l=0,r=0,i=100,s=100);const d=Math.round(10*(i-l+2*c))/10,h=Math.round(10*(s-r+2*c))/10,u=Math.round(10*(l-c))/10;let m=`<svg width="${d}" height="${h}" viewBox="${u} ${Math.round(10*(r-c))/10} ${d} ${h}" xmlns="http://www.w3.org/2000/svg">`;n.forEach((e=>{if(!Array.isArray(e.points)||e.points.length<2)return;const t=e.points.map((([e,t])=>[Math.round(10*e)/10,Math.round(10*t)/10]));let a=`M${t[0][0]} ${t[0][1]}`,n=t[0][0],o=t[0][1],l=0,r=0;if(2===t.length){a+=`l${Math.round(100*(t[1][0]-n))/100} ${Math.round(100*(t[1][1]-o))/100}`}else for(let e=0;e<t.length-1;e++){const i=t[e>0?e-1:e],s=t[e],c=t[e+1],d=t[e+2<t.length?e+2:e+1],p=.3,h=Math.round((c[0]-i[0])*p*100)/100,u=Math.round((c[1]-i[1])*p*100)/100,m=Math.round((d[0]-s[0])*p*100)/100,g=Math.round((d[1]-s[1])*p*100)/100,y=Math.round(100*h)/100,f=Math.round(100*u)/100,b=Math.round(100*(c[0]-s[0]-m))/100,v=Math.round(100*(c[1]-s[1]-g))/100,w=Math.round(100*(c[0]-s[0]))/100,E=Math.round(100*(c[1]-s[1]))/100;if(0===e)a+=`c${y} ${f} ${b} ${v} ${w} ${E}`;else{Math.round(100*-l),Math.round(100*-r);a+=`s${b} ${v} ${w} ${E}`}l=b,r=v,n=c[0],o=c[1]}m+=`<path d="${a}" stroke="${e.color||"#fff"}" stroke-width="${e.size||1}" stroke-linecap="round" fill="none"/>`})),o.forEach((e=>{if(!e.dataUrl)return;const t=Math.round(10*e.x)/10,a=Math.round(10*e.y)/10,n=Math.round(10*(e.width||0))/10,o=Math.round(10*(e.height||0))/10;m+=`<image x="${t}" y="${a}" width="${n}" height="${o}" href="${e.dataUrl}"/>`})),m+="</svg>";const g=new Blob([m],{type:"image/svg+xml"}),y=URL.createObjectURL(g);createElement("a",{href:y,download:`whiteboard_${Date.now()}.svg`}).click(),setTimeout((()=>URL.revokeObjectURL(y)),100)}catch(e){alert("Failed to export SVG: "+e.message)}}},"Export SVG"),fe=createElement("input",{type:"file",accept:"application/json",style:{display:"none"},onchange:e=>{const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=()=>{try{const e=JSON.parse(a.result);e.paths&&e.images&&e.panZoom&&(p.paths=e.paths,p.images=e.images,p.panZoom=e.panZoom,h=p.paths,u=p.images,({offsetX:g,offsetY:y,scale:f}=p.panZoom),m=[],e.images.forEach((e=>{const t=new Image;t.onload=()=>Ae(),t.src=e.dataUrl,m.push(t)})),De(),Ae())}catch(e){}},a.readAsText(t)}}),be=createElement("button",{type:"button",onclick:()=>{fe.value="",fe.click()}},"Import"),ve=createToolbar([V,Y,K,Q,X,ee,ae,ne,ie,se,ce,de,he,oe,re,ue,me],[ge,ye,be]);e.appendChild(ve);const we=createElement("div",{class:"whiteboard-container"});c=createElement("canvas",{style:{cursor:"none"},class:"whiteboard-context"}),we.appendChild(c),e.appendChild(we),d=c.getContext("2d"),document.oncontextmenu=()=>!1,window.whiteboardData[t.id]=window.whiteboardData[t.id]||{paths:[],images:[],panZoom:{offsetX:0,offsetY:0,scale:1},areDotsVisible:!0,backgroundColor:"#12111b"},p=window.whiteboardData[t.id],h=p.paths,u=p.images,m=[],({offsetX:g,offsetY:y,scale:f}=p.panZoom),_=p.areDotsVisible,le=p.backgroundColor,oe.style.backgroundImage=s("dotsVisibility",_?"#ff5100":"white"),re.value=le,u.forEach((e=>{const t=new Image;t.onload=()=>Ae(),t.src=e.dataUrl,m.push(t)}));const Ee=document.createElement("canvas"),xe=Ee.getContext("2d"),Ce=e=>(e+g)*f,ke=e=>(e+y)*f,Se=e=>e/f-g,Ie=e=>e/f-y,De=(e=f)=>{Ee.width=we.clientWidth||1,Ee.height=we.clientHeight||1;let t=g*e%n,a=y*e%n;if(t<0&&(t+=n),a<0&&(a+=n),xe.fillStyle=o,xe.clearRect(0,0,Ee.width,Ee.height),_)for(let e=t;e<Ee.width;e+=n)for(let t=a;t<Ee.height;t+=n)xe.beginPath(),xe.arc(e,t,1,0,2*Math.PI),xe.fill()},Te=e=>{d.beginPath();const t=e.points;if(t.length<2)return;const[a,n]=t[0];if(d.moveTo(Ce(a),ke(n)),e.snapped)for(let e=1;e<t.length;e++){const[a,n]=t[e];d.lineTo(Ce(a),ke(n))}else if(2===t.length){const[e,a]=t[1];d.lineTo(Ce(e),ke(a))}else{for(let e=1;e<t.length-1;e++){const[a,n]=t[e-1],[o,l]=t[e],[r,i]=t[e+1],s=(o+r)/2,c=(l+i)/2;d.quadraticCurveTo(Ce(o),ke(l),Ce(s),ke(c))}const[e,a]=t[t.length-1];d.lineTo(Ce(e),ke(a))}d.strokeStyle=e.color,d.lineWidth=e.size*f,d.lineCap="round",d.stroke()},Le=()=>{if(c.width=we.clientWidth,c.height=we.clientHeight,De(),d.fillStyle=le,d.fillRect(0,0,c.width,c.height),d.drawImage(Ee,0,0),u.forEach(((e,t)=>{const a=m[t];a&&a.complete&&d.drawImage(a,Ce(e.x),ke(e.y),e.width*f,e.height*f)})),h.forEach(Te),U&&Te(U),L){const e=c.width/2,t=c.height/2;d.save(),d.strokeStyle=o,d.lineWidth=1,d.beginPath(),d.moveTo(0,t),d.lineTo(c.width,t),d.moveTo(e,0),d.lineTo(e,c.height),d.stroke(),d.restore()}if(P){const e=Math.min(P.x0,P.x1),t=Math.max(P.x0,P.x1),a=Math.min(P.y0,P.y1),n=Math.max(P.y0,P.y1),o=Ce(t)-Ce(e),l=ke(n)-ke(a),r=Ce(e),i=ke(a);((e,t,a,n,o,l,r,i,s)=>{e.save(),e.strokeStyle=r,e.lineWidth=i,e.setLineDash(s),e.beginPath(),e.moveTo(t+l,a),e.lineTo(t+n-l,a),e.quadraticCurveTo(t+n,a,t+n,a+l),e.lineTo(t+n,a+o-l),e.quadraticCurveTo(t+n,a+o,t+n-l,a+o),e.lineTo(t+l,a+o),e.quadraticCurveTo(t,a+o,t,a+o-l),e.lineTo(t,a+l),e.quadraticCurveTo(t,a,t+l,a),e.closePath(),e.stroke(),e.restore()})(d,r,i,o,l,6,"#6e6e6e",2,[10,5])}if(O){const e=Ce(O.x+O.width),t=ke(O.y);d.save(),d.fillStyle="red",d.beginPath(),d.roundRect(e-10,t-10,20,20,5),d.fill(),d.strokeStyle="white",d.lineWidth=2,d.beginPath(),d.moveTo(e-5,t-5),d.lineTo(e+5,t+5),d.moveTo(e+5,t-5),d.lineTo(e-5,t+5),d.stroke(),d.restore()}},Ae=((e,t)=>{let a;return(...n)=>{a||(e(...n),a=setTimeout((()=>a=null),t))}})(Le,16),Me=()=>{if(A&&R){let e=Se(C)-j/2,t=Ie(k)-F/2;if(M){const a=r(Ce(e),ke(t));e=Se(a.x),t=Ie(a.y)}d.save(),d.globalAlpha=.5,R.forEach((a=>{d.beginPath();const[n,o]=a.points[0];d.moveTo(Ce(n+e),ke(o+t));for(let n=1;n<a.points.length;n++){const[o,l]=a.points[n];d.lineTo(Ce(o+e),ke(l+t))}d.strokeStyle=a.color,d.lineWidth=a.size*f,d.lineCap="round",d.stroke()})),d.restore()}else if(J){const e=T?4*E:E;d.beginPath(),d.arc(C,k,e/2+1,0,2*Math.PI),d.strokeStyle=T?"red":"gray",d.lineWidth=1,d.stroke()}},Re=(e,t)=>{const a=e.getBoundingClientRect();return{x:t.touches[0].clientX-a.left,y:t.touches[0].clientY-a.top}},Pe=(e,t)=>{const n=Se(e),o=Ie(t);if(O){const a=Ce(O.x+O.width),n=ke(O.y);if(Math.sqrt((e-a)**2+(t-n)**2)<10){const e=u.indexOf(O);return-1!==e&&(u.splice(e,1),m.splice(e,1)),O=null,void Ae()}}const l=((e,t)=>{for(let a=u.length-1;a>=0;a--){const{x:n,y:o,width:l,height:r}=u[a];if(e>=n&&e<=n+l&&t>=o&&t<=o+r)return u[a]}return null})(n,o);if(l&&!D&&!T&&!L&&!A)return O=l,N=!0,B=l,b=n-l.x,v=o-l.y,void Ae();if(O=null,$=!0,A&&R){let n=Se(e)-j/2,o=Ie(t)-F/2;if(M){const e=r(Ce(n),ke(o));n=Se(e.x),o=Ie(e.y)}const l={paths:a(h)};R.forEach((e=>h.push({points:e.points.map((([e,t])=>[e+n,t+o])),color:e.color,size:e.size,snapped:e.snapped})));const i={paths:a(h)};return q({type:"paste",prevState:l,nextState:i}),void Ae()}if(D&&!T&&!L&&!A){const e=M?r(Ce(n),ke(o)):{x:Ce(n),y:ke(o)};U={points:[[Se(e.x),Ie(e.y)]],color:w,size:E/f,snapped:M}}A&&!R&&(P={x0:n,y0:o,x1:n,y1:o}),C=S=e,k=I=t},je=(e,t)=>{C=e,k=t;const n=Se(e),o=Ie(t);if(e<0||e>c.width||t<0||t>c.height){if($&&U&&D){const e={paths:a(h)};h.push(U);const t={paths:a(h)};q({type:"draw",prevState:e,nextState:t}),U=null,$=!1,Ae()}W=!0}else{if(N)B.x=n-b,B.y=o-v,W=!0;else if($){if(L)g+=(C-S)/f,y+=(k-I)/f,p.panZoom={offsetX:g,offsetY:y,scale:f},De(),W=!0;else if(T){const e=2*E/f,t={paths:a(h)};let l=!1;for(let t=h.length-1;t>=0;t--)i(h[t],n,o,e)&&(h.splice(t,1),l=!0);if(l){const e={paths:a(h)};q({type:"erase",prevState:t,nextState:e})}}else if(A&&!R&&P)P.x1=n,P.y1=o,W=!0;else if(U&&D){const e=M?r(Ce(n),ke(o)):{x:Ce(n),y:ke(o)};U.points.push([Se(e.x),Ie(e.y)]),U.points.length>2&&(U.points=l(U.points,f))}S=C,I=k}W=!0}},Fe=()=>{if(N)N=!1,B=null;else if($){if(U&&U.points.length>1){const e={paths:a(h)};h.push(U);const t={paths:a(h)};q({type:"draw",prevState:e,nextState:t})}U=null,$=!1,A&&P&&!R&&(ce.disabled=!1,ce.style.backgroundImage=s("copy","white"),de.disabled=!1,de.style.backgroundImage=s("cut","white")),Ae()}},Ue=e=>{if(!P)return;const t=Math.min(P.x0,P.x1),n=Math.max(P.x0,P.x1),o=Math.min(P.y0,P.y1),l=Math.max(P.y0,P.y1);j=n-t,F=l-o;const r=[],i=[];if(h.forEach(((a,s)=>{$e(a,t,o,n,l)&&(r.push(a),e&&i.push(s))})),R=r.map((e=>({points:e.points.map((([e,a])=>[e-t,a-o])),color:e.color,size:e.size,snapped:e.snapped}))),e){const e={paths:a(h)};for(let e=i.length-1;e>=0;e--)h.splice(i[e],1);const t={paths:a(h)};q({type:"cut",prevState:e,nextState:t})}else q({type:"copy",prevState:{paths:JSON.parse(JSON.stringify(h))},nextState:{paths:JSON.parse(JSON.stringify(h))}});P=null,ce.disabled=!0,ce.style.backgroundImage=s("copyDisabled","gray"),de.disabled=!0,de.style.backgroundImage=s("cutDisabled","gray"),Ae()},$e=(e,t,a,n,o)=>{for(let l=1;l<e.points.length;l++){const[r,i]=e.points[l-1],[s,c]=e.points[l];if(r>=t&&r<=n&&i>=a&&i<=o||s>=t&&s<=n&&c>=a&&c<=o)return!0;if(Oe(r,i,s,c,t,a,n,o))return!0}return!1},Oe=(e,t,a,n,o,l,r,i)=>Ne(e,t,a,n,o,l,o,i)||Ne(e,t,a,n,r,l,r,i)||Ne(e,t,a,n,o,l,r,l)||Ne(e,t,a,n,o,i,r,i),Ne=(e,t,a,n,o,l,r,i)=>{const s=(i-l)*(a-e)-(r-o)*(n-t);if(0===s)return!1;const c=((r-o)*(t-l)-(i-l)*(e-o))/s,d=((a-e)*(t-l)-(n-t)*(e-o))/s;return c>=0&&c<=1&&d>=0&&d<=1};c.addEventListener("mousedown",(e=>{0===e.button&&Pe(e.offsetX,e.offsetY)})),c.addEventListener("touchstart",(e=>{e.preventDefault();const t=Re(c,e);J=!0,Pe(t.x,t.y)}),{passive:!1}),c.addEventListener("mousemove",(e=>{C=e.offsetX,k=e.offsetY,J=!0,je(e.offsetX,e.offsetY)})),c.addEventListener("touchmove",(e=>{const t=Re(c,e);($||L||N)&&e.preventDefault(),J=!0,je(t.x,t.y)}),{passive:!1}),c.addEventListener("mouseup",Fe),c.addEventListener("touchend",(e=>{e.preventDefault(),J=!1,Fe(),W=!0}),{passive:!1}),c.addEventListener("mouseleave",(()=>{if(J=!1,$&&Fe(),$&&U&&D){const e={paths:a(h)};h.push(U);const t={paths:a(h)};q({type:"draw",prevState:e,nextState:t}),U=null,$=!1,Ae()}W=!0})),c.addEventListener("touchcancel",(e=>{e.preventDefault(),J=!1,Fe(),W=!0}),{passive:!1}),document.addEventListener("paste",(e=>{const t=(e.clipboardData||e.originalEvent.clipboardData).items;for(const e of t)if(0===e.type.indexOf("image")){const t=e.getAsFile(),a=new FileReader;a.onload=()=>{const e=a.result,t=new Image;t.onload=()=>{const a=t.naturalWidth,n=t.naturalHeight,o=.25*(c.width/f),l=o*(n/a),r=Se(C||c.width/2)-o/2,i=Ie(k||c.height/2)-l/2;u.push({dataUrl:e,x:r,y:i,width:o,height:l}),m.push(t),Ae()},t.src=e},a.readAsDataURL(t);break}e.preventDefault()}));let Be=0,Je=0,We="";const _e=()=>{!W&&C===Be&&k===Je&&D===("brush"===We)&&J||(Le(),Me(),Be=C,Je=k,We=D?"brush":"other",W=!1),requestAnimationFrame(_e)};window.addEventListener("resize",(()=>{De(),Ae()})),De(),Ae(),G(),requestAnimationFrame(_e)},renderCodeChannel=(container,channel)=>{container.innerHTML="";const saveButton=createElement("button",{},"Save"),runButton=createElement("button",{},"Run Code"),exportButton=createElement("button",{onclick:()=>{const e=channelCategories.find((e=>"Functions"===e.name));if(!e?.channels?.length)return;const t=new Blob([JSON.stringify(e.channels)],{type:"application/json"});createElement("a",{href:URL.createObjectURL(t),download:"code_functions.json"}).click()}},"Export"),importButton=createElement("button",{onclick:()=>{const e=createElement("input",{type:"file",accept:"application/json",style:{display:"none"}});e.addEventListener("change",(async e=>{const t=e.target.files[0];if(!t)return;const a=await readFileAsync(t);try{const e=JSON.parse(a.content);if(Array.isArray(e)){let t=channelCategories.find((e=>"Functions"===e.name));t||(t={name:"Functions",channels:[]},channelCategories.push(t)),e.forEach((e=>{const a=t.channels.findIndex((t=>t.name.toLowerCase()===e.name.toLowerCase()));-1!==a?t.channels[a]=e:t.channels.push(e)})),renderSidebar()}}catch{}})),e.click()}},"Import"),toolbar=createToolbar([],[saveButton,runButton,exportButton,importButton]);container.appendChild(toolbar);const ioContainer=createElement("div",{class:"toolbar",style:{display:"flex",alignItems:"center"}}),functionNameInput=createElement("input",{type:"text",placeholder:"Function Name..",style:{flex:"1",minWidth:"80px"}});ioContainer.appendChild(functionNameInput),container.appendChild(ioContainer);const wrapper=createElement("div",{class:"code-runner-wrapper"});container.appendChild(wrapper);const codeTextarea=createElement("textarea",{spellcheck:"false",class:"code-runner-textarea"});wrapper.appendChild(codeTextarea),window.codeData[channel.id]&&(codeTextarea.value=window.codeData[channel.id]),codeTextarea.addEventListener("input",(()=>{window.codeData[channel.id]=codeTextarea.value}));const outputDiv=createElement("div",{class:"code-runner-output"});wrapper.appendChild(outputDiv),runButton.addEventListener("click",(()=>{const code=codeTextarea.value,logs=[],originalLog=console.log;console.log=(...e)=>{logs.push(e.join(" ")),originalLog(...e)};try{const result=eval(code);outputDiv.textContent=logs.length?logs.join("\n"):void 0!==result?result:"Code executed successfully."}catch(e){outputDiv.textContent="Error: "+e}console.log=originalLog})),functionNameInput.addEventListener("input",(()=>{const e=channelCategories.find((e=>"Functions"===e.name));saveButton.textContent=e&&e.channels.find((e=>e.name.toLowerCase()===functionNameInput.value.trim().toLowerCase()))?"Update":"Save"})),saveButton.addEventListener("click",(()=>{const e=codeTextarea.value;if(!e.trim())return;let t=channelCategories.find((e=>"Functions"===e.name));t||(t={name:"Functions",channels:[]},channelCategories.push(t));let a=functionNameInput.value.trim()||"Saved Function "+(t.channels.length+1);const n=t.channels.findIndex((e=>e.name.toLowerCase()===a.toLowerCase()));if(-1!==n)t.channels[n].code=e;else{const n="func_"+Date.now()+"_"+Math.random().toString(36).substring(2,9);t.channels.push({id:n,name:a,type:"function",code:e})}renderSidebar(),saveButton.textContent="Save"}))},renderCryptChannel=(e,t)=>{e.innerHTML="";const a=createElement("div",{class:"crypt-container"}),n=createElement("div",{class:"iosec",style:{display:"flex",justifyContent:"space-between",flexWrap:"wrap"}});let o=!1,l="",r="";const i=()=>{const e=c.value||o,t=R.value,a=f.value&&!f._binaryData,n=o&&f._binaryData;L.disabled=!e||!t,A.disabled=!e||!t,d.disabled=!c.value,P.disabled=!t,w.disabled=!n,v.disabled=!a},s=createElement("div",{style:{flex:"1",marginRight:"5px"}}),c=createElement("textarea",{placeholder:"Enter your message here",rows:"10",class:"crypt-textarea"}),d=createElement("button",{onclick:()=>{navigator.clipboard.writeText(c.value)},disabled:!0},"Copy Message"),p=createElement("button",{onclick:()=>{m.click()}},"Attach File"),h=createElement("button",{onclick:()=>{o=!1,l="",r="",c.disabled=!1,f.disabled=!0,c.value="",f.value="",c.placeholder="Enter your message here",f.placeholder="The result will appear here",h.style.display="none",p.style.display="inline",u.textContent="",i()},style:{display:"none"}},"Clear File"),u=createElement("div",{class:"info"}),m=createElement("input",{type:"file",style:{display:"none"}});m.addEventListener("click",(()=>{m.value=""})),m.addEventListener("change",(function(){if(m.files&&m.files[0]){const e=m.files[0];l=e.name,r=e.type||"application/octet-stream",o=!0,c.disabled=!0,f.disabled=!0,c.placeholder="File content loaded (binary data)",f.placeholder="Encrypted/Decrypted file content will appear here",h.style.display="inline",p.style.display="none",u.textContent=`File: ${l} (${j(e.size)})`;const t=new FileReader;t.onload=e=>{const t=e.target.result,a=new Uint8Array(t);c.value="_BINARY_DATA_",c._binaryData=a,i()},t.readAsArrayBuffer(e)}})),s.appendChild(c);const g=createElement("div",{style:{display:"flex",justifyContent:"space-between"}});g.appendChild(p),g.appendChild(h),g.appendChild(d),s.appendChild(g),s.appendChild(u),s.appendChild(m),n.appendChild(s);const y=createElement("div",{style:{flex:"1",marginLeft:"5px"}}),f=createElement("textarea",{placeholder:"The result will appear here",disabled:!0,rows:"10",class:"crypt-textarea"}),b=createElement("div",{class:"info"}),v=createElement("button",{onclick:()=>{navigator.clipboard.writeText(f.value)},disabled:!0},"Copy Result"),w=createElement("button",{onclick:()=>{if(o&&f._binaryData){let e=l;if(e.includes(".")){const t=e.split(".");t.pop();const a=t.join(".");e=e.endsWith(".enc")?a:`${e}.enc`}else e=`${e}.enc`;const t=new Blob([f._binaryData],{type:r}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}else{const e=new Blob([f.value],{type:"text/plain"}),t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="result.txt",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(t)}},disabled:!0},"Download");y.appendChild(f);const E=createElement("div",{style:{display:"flex",justifyContent:"space-between"}});E.appendChild(w),E.appendChild(v),y.appendChild(E),y.appendChild(b),n.appendChild(y),a.appendChild(n);const x=createElement("div",{style:{display:"flex",alignItems:"center",flexWrap:"wrap"}}),C=createElement("label",{style:{margin:"var(--margin-small)"}},"Password Length: "),k=createElement("input",{type:"range",min:"16",max:"200",value:"24",oninput:e=>{S.textContent=e.target.value}}),S=createElement("span",{},k.value);C.appendChild(k),C.appendChild(S),x.appendChild(C);const I=createElement("button",{onclick:()=>{const e=parseInt(k.value,10);R.value=F(e),i()}},"Generate"),D=createElement("input",{type:"file",style:{display:"none"}}),T=createElement("button",{onclick:()=>D.click()},"Attach");D.addEventListener("change",(async()=>{const e=D.files[0];if(e){const t=await readFileAsync(e);R.value=t.content.trim(),i(),D.value=""}}));const L=createElement("button",{disabled:!0},"Encrypt"),A=createElement("button",{disabled:!0},"Decrypt");x.appendChild(I),x.appendChild(T),x.appendChild(D),x.appendChild(L),x.appendChild(A),a.appendChild(x);const M=createElement("div",{style:{display:"flex",alignItems:"center"}}),R=createElement("input",{type:"text",placeholder:"Enter encryption key",class:"crypt-textarea",style:{flex:"1"}}),P=createElement("button",{onclick:()=>{navigator.clipboard.writeText(R.value)},disabled:!0},"Copy Key");M.appendChild(R),M.appendChild(P),a.appendChild(M),e.appendChild(a);const j=e=>e<1024?e+" bytes":e<1048576?(e/1024).toFixed(2)+" KB":(e/1048576).toFixed(2)+" MB",F=e=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ¡¢£¤¥¦§¨©«®¯°±²³´µ¶·¸¹º¼½¾¿€©®™×÷ƒ∑∆∂∞≈≠≡≤≥⊂⊃∈∉√π∞∩∪⊥∧∨∩≈⊕⊗∫";let a="";for(let n=0;n<e;n++)a+=t.charAt(Math.floor(Math.random()*t.length));return a};c.addEventListener("input",i),R.addEventListener("input",i),m.addEventListener("change",i),f.addEventListener("input",i),L.onclick=async()=>{if(R.value.length>=16)try{if(o&&c._binaryData){const e=c._binaryData,[t,a,n]=await(async(e,t)=>{const a=crypto.getRandomValues(new Uint8Array(16)),n=crypto.getRandomValues(new Uint8Array(12)),o=await deriveKey(t,a),l=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},o,e);return[new Uint8Array(l),n,a]})(e,R.value);f._binaryData=(e=>{const t=e.reduce(((e,t)=>e+t.length),0),a=new Uint8Array(t);let n=0;return e.forEach((e=>{a.set(e,n),n+=e.length})),a})([n,a,t]),f.value="_ENCRYPTED_BINARY_DATA_",f.disabled=!0,b.textContent=`Encrypted: ${j(f._binaryData.length)} (ready to download)`}else{f._binaryData=null;const{encryptedText:e,iv:t,salt:a}=await encryptText(c.value,R.value);f.value=e,f.iv=t,f.salt=a,f.disabled=!0,b.textContent=""}i()}catch(e){b.textContent=`Encryption failed: ${e.message}`}else b.textContent="Please enter an encryption key of minimum 16 characters."},A.onclick=async()=>{if(R.value.length>=16)try{if(o&&c._binaryData){const e=c._binaryData,t=e.slice(0,16),a=e.slice(16,28),n=e.slice(28),o=await(async(e,t,a,n)=>{const o=await deriveKey(t,n),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:a},o,e);return new Uint8Array(l)})(n,R.value,a,t);f._binaryData=o,f.value="_DECRYPTED_BINARY_DATA_",f.disabled=!0,b.textContent=`Decrypted: ${j(o.length)} (ready to download)`,i()}else try{const e=await decryptText(c.value,R.value);f.value=e,b.textContent="",i()}catch(e){b.textContent=`Decryption failed: ${e.message}`}}catch(e){b.textContent=`Decryption failed: ${e.message}. Make sure the input is valid and the encryption key is correct.`}else b.textContent="Please enter an encryption key (minimum 16 characters)."},i()},renderReminderChannel=(e,t)=>{e.innerHTML="";const a=e=>{const{r:t,g:a,b:n}=(e=>{if((e=e.trim().toLowerCase()).startsWith("#")){let t=e.slice(1);return[3,4].includes(t.length)&&(t=t.split("").map((e=>e+e)).join("")),{r:parseInt(t.substring(0,2),16),g:parseInt(t.substring(2,4),16),b:parseInt(t.substring(4,6),16)}}if(e.startsWith("rgb")){const t=e.match(/(\d+)/g)||[];return{r:+t[0]||0,g:+t[1]||0,b:+t[2]||0}}return{r:255,g:255,b:255}})(e),o=e=>(e/=255)<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4);return.2126*o(t)+.7152*o(a)+.0722*o(n)>.179?"#000000":"#ffffff"};reminders[t.id]=reminders[t.id]||[];const n=createElement("div"),o=createElement("form",{onsubmit:e=>{e.preventDefault(),reminders[t.id].push({date:l.value||null,text:r.value,color:i.value}),l.value="",r.value="",s()},style:{display:"flex",flexWrap:"wrap",alignItems:"center"}}),l=createElement("input",{type:"datetime-local",style:{colorScheme:"dark"}}),r=createElement("input",{type:"text",placeholder:"Reminder text",required:!0}),i=createElement("input",{type:"color",value:"#007bff",style:{colorScheme:"dark"}});o.append(l,r,i,createElement("button",{type:"submit"},"Add Reminder")),e.appendChild(o),e.appendChild(n);const s=()=>{n.innerHTML="",reminders[t.id].forEach(((e,o)=>{const l=createElement("div",{class:"reminder-container",style:{backgroundColor:e.color,color:a(e.color)}});e.date&&l.appendChild(createElement("div",{},new Date(e.date).toLocaleString())),l.appendChild(createElement("div",{},e.text)),l.appendChild(createElement("button",{style:{position:"absolute",top:"0",right:"0",padding:"2px 8px",border:"none",background:"transparent",color:"inherit",cursor:"pointer",fontSize:"14px",borderRadius:"0 4px 0 4px"},onclick:()=>{reminders[t.id].splice(o,1),s()}},"×")),n.appendChild(l)}))};s()};let autoSaveIntervalId=null,isAutoSaveEnabled="true"===localStorage.getItem("autoSaveEnabled"),autoSaveInterval=parseInt(localStorage.getItem("autoSaveInterval"),10)||3e4,lastSaveTimestamp=Date.now(),countdownIntervalId=null;async function deriveKey(e,t){const a=new TextEncoder,n=await crypto.subtle.importKey("raw",a.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e4,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}const arrayToHex=e=>Array.from(e).map((e=>("0"+e.toString(16)).slice(-2))).join(""),hexToArray=e=>{const t=e.length/2,a=new Uint8Array(t);for(let n=0;n<t;n++)a[n]=parseInt(e.substring(2*n,2*n+2),16);return a},encryptText=async(e,t)=>{const a=crypto.getRandomValues(new Uint8Array(16)),n=crypto.getRandomValues(new Uint8Array(12)),o=(new TextEncoder).encode(e),l=await deriveKey(t,a),r=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},l,o);return{encryptedText:arrayToHex(a)+":"+arrayToHex(n)+":"+arrayToHex(new Uint8Array(r)),iv:arrayToHex(n),salt:arrayToHex(a)}},decryptText=async(e,t)=>{const[a,n,o]=e.split(":");if(!a||!n||!o)throw new Error("Invalid encrypted message format");const l=hexToArray(a),r=hexToArray(n),i=hexToArray(o),s=await deriveKey(t,l),c=await crypto.subtle.decrypt({name:"AES-GCM",iv:r},s,i);return(new TextDecoder).decode(c)},saveData=async e=>{const t={chatMessages:chatMessages,flashcards:flashcards,codeData:window.codeData,reminders:reminders,categories:channelCategories,whiteboardData:window.whiteboardData,theme:JSON.parse(localStorage.getItem("customTheme")||"{}")},a={encrypted:!1,data:t,whiteboardData:window.whiteboardData};if(e)try{const n=JSON.stringify(t),o=await encryptText(n,e);a.encrypted=!0,a.data=o,localStorage.setItem("isEncrypted","true")}catch(e){alert("Failed to encrypt data. Saving unencrypted."),a.encrypted=!1,a.data=t,localStorage.setItem("isEncrypted","false")}else localStorage.setItem("isEncrypted","false");localStorage.setItem("appData",JSON.stringify(a)),lastSaveTimestamp=Date.now()},startAutoSave=()=>{stopAutoSave(),autoSaveIntervalId=setInterval((()=>saveData("")),autoSaveInterval)},stopAutoSave=()=>{autoSaveIntervalId&&(clearInterval(autoSaveIntervalId),autoSaveIntervalId=null)},startCountdownDisplay=e=>{stopCountdownDisplay(),updateCountdownDisplay(e),countdownIntervalId=setInterval((()=>updateCountdownDisplay(e)),100)},stopCountdownDisplay=()=>{countdownIntervalId&&(clearInterval(countdownIntervalId),countdownIntervalId=null)},updateCountdownDisplay=e=>{if(isAutoSaveEnabled){const t=Date.now()-lastSaveTimestamp,a=Math.max(0,autoSaveInterval-t);e.textContent=`Auto-save in: ${(a/1e3).toFixed(1)}s`}else e.textContent="Auto-save in: --s"},renderFilesChannel=(e,t)=>{e.innerHTML="";let a=[],n=!1,o=null,l=null,r="",i=[],s=0;const c=createElement("div",{style:{width:"100%",display:"flex",alignItems:"center"}}),d=createElement("span",{class:"info"},"Supported: JPG, PNG, WebP, PDF"),p=createElement("div",{style:{width:"100%",display:"flex",flexDirection:"column",alignItems:"center",marginTop:"20px"}}),h=createElement("div",{style:{position:"relative",width:"100%",height:"calc(100vh - 200px)",display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"}}),u=createElement("button",{style:{position:"absolute",left:"10px",top:"50%",transform:"translateY(-50%)",fontSize:"24px",border:"none",display:"none"},disabled:!0},"←"),m=createElement("button",{style:{position:"absolute",right:"10px",top:"50%",transform:"translateY(-50%)",fontSize:"24px",border:"none",display:"none",alignItems:"center"},disabled:!0},"→"),g=createElement("img",{style:{width:"100%",height:"auto",maxWidth:"100%",maxHeight:"100%",objectFit:"contain",display:"none"}}),y=createElement("div",{style:{margin:"var(--margin-small)",display:"none",width:"300px"}}),f=createElement("label",{style:{marginRight:"10px"}},"Threshold: 128"),b=createElement("input",{type:"range",min:"64",max:"128",value:"120",style:{width:"200px"}});b.addEventListener("touchstart",(e=>{e.stopPropagation()})),b.addEventListener("touchmove",(e=>{e.stopPropagation()}),{passive:!0});const v=createElement("input",{type:"file",accept:".jpg,.jpeg,.png,.webp,.pdf,.svg",multiple:!0,style:{display:"none"},onchange:function(e){a=Array.from(e.target.files),n=!1,C.disabled=!0,k.disabled=!0,I.disabled=!0,o=null,l=null,r="",S.value="",v.value="",function(){if(x.innerHTML="",!a.length)return x.innerHTML='<option value="">Select files to choose conversion</option>',x.disabled=!0,C.disabled=!0,void D();x.disabled=!1;let e=!1;for(const[t,n]of Object.entries(E)){if(a.every((e=>{const t="."+e.name.split(".").pop().toLowerCase();return n.formats.includes(t)}))){const a=createElement("option",{value:t},n.label);x.appendChild(a),e=!0}}if(e){const e=x.value,t=E[e];C.disabled=!n&&(!t||a.length>1&&!t.multiFile)}else x.innerHTML='<option value="">No conversions available</option>',x.disabled=!0,C.disabled=!0;D()}(),i=[],s=0,A()}}),w=createElement("button",{onclick:()=>v.click()},"Import File(s)"),E={base64:{label:"Image to Base64",formats:".jpg,.jpeg,.png,.webp,.svg",supports:"JPG, PNG, WebP, SVG",multiFile:!1},pdfToImages:{label:"PDF to Images",formats:".pdf",supports:"PDF",multiFile:!1},pdfToImagesHD:{label:"PDF to Images HD",formats:".pdf",supports:"PDF",multiFile:!1},pdfToImagesInverted:{label:"PDF to Images (Inverted)",formats:".pdf",supports:"PDF",multiFile:!1},pdfToImagesHDInverted:{label:"PDF to Images HD (Inverted)",formats:".pdf",supports:"PDF",multiFile:!1},scanImages:{label:"Scan Images",formats:".jpg,.jpeg,.png,.webp",supports:"JPG, PNG, WebP",multiFile:!0},imagesToPdf:{label:"Image(s) to PDF",formats:".jpg,.jpeg,.png,.webp",supports:"JPG, PNG, WebP",multiFile:!0},imagesToSvg:{label:"Image(s) to SVG",formats:".jpg,.jpeg,.png,.webp",supports:"JPG, PNG, WebP",multiFile:!0}},x=createElement("select",{style:{margin:"var(--margin-small)"},onchange:()=>{if(D(),a.length){const e=x.value,t=E[e];C.disabled=!n&&(!t||a.length>1&&!t.multiFile)}}});x.innerHTML='<option value="">Select files to convert</option>',x.disabled=!0;const C=createElement("button",{disabled:!0,onclick:async function(){if(!a.length)return void alert("Please select at least one file.");const e=x.value;if(!e)return void alert("Please select a valid conversion option.");const t=E[e];if(a.length>1&&!t.multiFile)return void alert("This conversion option does not support multiple files.");o=null,l=null,r="",S.value="",k.disabled=!0,I.disabled=!0;try{switch(e){case"base64":await async function(){const e=await R(a[0]);o="text",l=e.content,r=`${a[0].name.split(".").slice(0,-1).join(".")||"input"}_base64.txt`,S.value=l,k.disabled=!1,I.disabled=!1}();break;case"pdfToImages":await T(!1,2);break;case"pdfToImagesHD":await T(!1,3);break;case"pdfToImagesInverted":await T(!0,2);break;case"pdfToImagesHDInverted":await T(!0,3);break;case"scanImages":await async function(){if(!window.JSZip)throw new Error("JSZip library is not loaded.");i=[],s=0;for(let e=0;e<a.length;e++){const t=a[e],n=await R(t),o=await M(n.content),l=document.createElement("canvas"),r=l.getContext("2d"),s=.6;l.width=o.width*s,l.height=o.height*s,r.drawImage(o,0,0,l.width,l.height),L(r,l.width,l.height),i.push({previewDataUrl:l.toDataURL("image/png"),originalDataUrl:n.content,threshold:120})}A(),o="blob",l=null,r="scanned_images.zip",S.value="Adjust threshold and click Download to get scanned images",k.disabled=!1,I.disabled=!0}();break;case"imagesToPdf":await async function(){const e=window.jspdf.jsPDF;if(!e)throw new Error("jsPDF library is not loaded.");const t=.1,n=new e({format:[1,1]});for(let e=0;e<a.length;e++){const o=a[e];let l=await R(o).then((e=>e.content)),r=l.split(";")[0].split("/")[1].toUpperCase();if("WEBP"===r){const e=await M(l),t=document.createElement("canvas");t.width=e.width,t.height=e.height;t.getContext("2d").drawImage(e,0,0),l=t.toDataURL("image/png"),r="PNG"}const i=await M(l),s=i.width*t,c=i.height*t;e>0?n.addPage([s,c]):(n.internal.pageSize.width=s,n.internal.pageSize.height=c),n.setPage(e+1),n.addImage(l,r,0,0,s,c)}const i=n.output("blob");o="blob",l=i,r="images_to_pdf.pdf",S.value="PDF ready for download",k.disabled=!1,I.disabled=!0}();break;case"imagesToSvg":await async function(){const e=[];for(const t of a){const a=await R(t),n=await M(a.content),o=16,l=Math.min(o/n.width,o/n.height,1),r=document.createElement("canvas");r.width=Math.floor(n.width*l),r.height=Math.floor(n.height*l);const i=r.getContext("2d");i.drawImage(n,0,0,r.width,r.height);const s=j(i.getImageData(0,0,r.width,r.height),r.width,r.height);e.push({name:`${t.name.split(".").slice(0,-1).join(".")||"image"}.svg`,content:s})}if(1===e.length)o="text",l=e[0].content,r=e[0].name,S.value=l,k.disabled=!1,I.disabled=!1;else{const t=window.JSZip;if(!t)throw new Error("JSZip library is not loaded.");const a=new t;e.forEach((e=>{a.file(e.name,e.content)}));const n=await a.generateAsync({type:"blob"});o="blob",l=n,r="images_to_svg.zip",S.value="ZIP file with SVGs ready for download",k.disabled=!1,I.disabled=!0}}();break;default:alert("Unknown conversion option.")}n=!0,C.disabled=!0}catch(e){alert(`Conversion failed: ${e.message}`)}}},"Convert"),k=createElement("button",{disabled:!0,onclick:async()=>{if("blob"===o||l)if("text"===o)P("data:text/plain;charset=utf-8,"+encodeURIComponent(l),r);else if("scanImages"===x.value)try{k.disabled=!0,k.textContent="Processing...";const e=window.JSZip;if(!e)throw new Error("JSZip library is not loaded.");const t=new e;for(let e=0;e<i.length;e++){const n=a[e],o=await M(i[e].originalDataUrl),l=document.createElement("canvas"),r=l.getContext("2d");l.width=o.width,l.height=o.height,r.drawImage(o,0,0),L(r,l.width,l.height,i[e].threshold);const s=await new Promise((e=>l.toBlob(e,"image/png",1))),c=await s.arrayBuffer();t.file(`Scanned_${n.name.split(".").slice(0,-1).join(".")||"image"}_${e+1}.png`,c)}const n=await t.generateAsync({type:"blob"}),o=URL.createObjectURL(n);P(o,r),setTimeout((()=>URL.revokeObjectURL(o)),100),S.value="ZIP file with scanned images ready for download",k.disabled=!1,k.textContent="Download"}catch(e){alert(`Download failed: ${e.message}`),S.value="Download failed",k.disabled=!1,k.textContent="Download"}else if("blob"===o&&l){const e=URL.createObjectURL(l);P(e,r),setTimeout((()=>URL.revokeObjectURL(e)),100)}}},"Download"),S=createElement("input",{type:"text",placeholder:"Converted output will appear here...",readonly:!0,style:{flexGrow:1,marginRight:"5px"}}),I=createElement("button",{disabled:!0,onclick:()=>{S.value&&navigator.clipboard.writeText(S.value)}},"Copy");function D(){const e=E[x.value];d.textContent=e?`Supported: ${e.supports}`:"Supported: JPG, PNG, WebP, PDF"}async function T(e,t){const n=await async function(e,t=!1,a=2){if(!window.pdfjsLib||!window.JSZip)throw new Error("Required libraries (pdf.js or JSZip) are not loaded.");const n=window.pdfjsLib,o=window.JSZip,l=await e.arrayBuffer(),r=await n.getDocument({data:l}).promise,i=new o;for(let e=1;e<=r.numPages;e++){const n=await r.getPage(e),o=n.getViewport({scale:a}),l=document.createElement("canvas"),s=l.getContext("2d");l.width=o.width,l.height=o.height;const c={canvasContext:s,viewport:o};if(await n.render(c).promise,t){const e=s.getImageData(0,0,l.width,l.height),t=e.data;for(let e=0;e<t.length;e+=4)t[e]=255-t[e],t[e+1]=255-t[e+1],t[e+2]=255-t[e+2];s.putImageData(e,0,0)}const d=await new Promise((e=>l.toBlob(e,"image/png",1))),p=await d.arrayBuffer();i.file(`Page_${e}.png`,p)}return await i.generateAsync({type:"blob"})}(a[0],e,t);o="blob",l=n,r=`${a[0].name.split(".").slice(0,-1).join(".")||"input"}_pages.zip`,S.value="ZIP file ready for download",k.disabled=!1,I.disabled=!0}function L(e,t,a,n=120){const o=e.getImageData(0,0,t,a),l=o.data,r=l.length,i=n/128,s=new Float32Array(t*a);for(let e=0,a=0;e<r;e+=4,a++){const n=.2989*l[e]+.587*l[e+1]+.114*l[e+2],o=a%t,r=Math.floor(a/t);s[a]=n+(o>0?s[a-1]:0)+(r>0?s[a-t]:0)-(o>0&&r>0?s[a-t-1]:0)}for(let e=0;e<a;e++){const n=Math.max(0,e-15),o=Math.min(a-1,e+15);for(let a=0;a<t;a++){const r=e*t+a<<2,c=.2989*l[r]+.587*l[r+1]+.114*l[r+2],d=Math.max(0,a-15),p=Math.min(t-1,a+15),h=d>0&&n>0?s[(n-1)*t+(d-1)]:0,u=n>0?s[(n-1)*t+p]:0,m=d>0?s[o*t+(d-1)]:0,g=c<(s[o*t+p]-u-m+h)/((p-d+1)*(o-n+1))*i?0:255;l[r]=l[r+1]=l[r+2]=g}}const c=new Uint8ClampedArray(l),d=[1,2,1,2,4,2,1,2,1];for(let e=1;e<a-1;e++)for(let a=1;a<t-1;a++){let n=0,o=0,r=0;for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++){const c=(e+i)*t+(a+s)<<2,p=d[3*(i+1)+(s+1)];n+=l[c]*p,o+=l[c+1]*p,r+=l[c+2]*p}const i=e*t+a<<2;c[i]=n/16,c[i+1]=o/16,c[i+2]=r/16}for(let e=0;e<r;e++)l[e]=c[e];e.putImageData(o,0,0),e.filter="contrast(2.0)";const p=document.createElement("canvas");p.width=t,p.height=a,p.getContext("2d").putImageData(o,0,0),e.drawImage(p,0,0),e.filter="none"}function A(){if(!i.length)return g.style.display="none",u.style.display="none",m.style.display="none",void(y.style.display="none");g.src=i[s].previewDataUrl,g.style.display="block",u.style.display="block",m.style.display="block",u.disabled=0===s,m.disabled=s===i.length-1,y.style.display="block",f.textContent=`Threshold: ${b.value}`}u.onclick=()=>{s>0&&(s--,A())},m.onclick=()=>{s<i.length-1&&(s++,A())},b.oninput=async()=>{const e=parseInt(b.value);f.textContent=`Threshold: ${e}`;const t=i[s],a=document.createElement("canvas"),n=a.getContext("2d"),o=await M(t.originalDataUrl);a.width=.6*o.width,a.height=.6*o.height,n.drawImage(o,0,0,a.width,a.height),L(n,a.width,a.height,e),g.src=a.toDataURL("image/png"),i[s].previewDataUrl=g.src,i[s].threshold=e};const M=e=>new Promise(((t,a)=>{const n=new Image;n.onload=()=>t(n),n.onerror=a,n.src=e})),R=e=>new Promise(((t,a)=>{const n=new FileReader;n.onload=()=>t({content:n.result}),n.onerror=a,n.readAsDataURL(e)})),P=(e,t)=>{const a=createElement("a",{href:e,download:t});document.body.appendChild(a),a.click(),document.body.removeChild(a)};function j(e,t,a,n=1){let o=`<svg width="${t*n}" height="${a*n}" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">\n`;for(let l=0;l<a;l++)for(let a=0;a<t;a++){const r=4*(l*t+a);o+=`<rect x="${a*n}" y="${l*n}" width="${n}" height="${n}" fill="${`rgba(${e.data[r]}, ${e.data[r+1]}, ${e.data[r+2]}, ${e.data[r+3]/255})`}" />\n`}return o+="</svg>",o}const F=createToolbar([w,x,C,k],[]);e.append(F,d,c,p),p.append(h,y),c.append(S,I),h.append(u,g,m),y.append(f,b)},renderSettingsChannel=(e,t)=>{e.innerHTML="";const a=createElement("button",{onclick:async()=>{if(a.disabled)return;const e={};Object.entries(D).forEach((([t,a])=>{const n=a.value;e[t]=n,document.documentElement.style.setProperty(t,n)})),localStorage.setItem("customTheme",JSON.stringify(e)),a.disabled=!0;const t=i.value.trim();await saveData(t),i.value="";const n=a.textContent;a.textContent="Saving...",w(),setTimeout((()=>{a.textContent=n,a.disabled=!1}),500)}},"Save data"),n=createElement("button",{class:"remove-btn"},"Erase memory");(()=>{let e=!1;n.addEventListener("click",(t=>{t.preventDefault(),e?(n.textContent="Erasing...",n.disabled=!0,(()=>{localStorage.removeItem("appData"),localStorage.removeItem("autoSaveEnabled"),localStorage.removeItem("autoSaveInterval"),localStorage.removeItem("isEncrypted"),Object.keys(chatMessages).forEach((e=>delete chatMessages[e])),Object.keys(flashcards).forEach((e=>delete flashcards[e])),Object.keys(reminders).forEach((e=>delete reminders[e])),window.whiteboardData={},window.codeData={};const e=channelCategories.findIndex((e=>"Functions"===e.name));-1!==e&&channelCategories.splice(e,1),renderSidebar(),isAutoSaveEnabled=!1,h.checked=!1,autoSaveInterval=3e4,m.value=autoSaveInterval,g.textContent=`Interval: ${autoSaveInterval/1e3}s`,stopAutoSave(),stopCountdownDisplay(),v.textContent="Auto-save in: --s",resetTheme(),localStorage.removeItem("customTheme"),w()})(),setTimeout((()=>{n.textContent="Erase memory",e=!1,n.disabled=!1}),500)):(n.textContent="Are you sure?",e=!0,n.disabled=!0,setTimeout((()=>n.disabled=!1),500))})),document.addEventListener("click",(t=>{t.target!==n&&e&&!n.disabled&&(n.textContent="Erase memory",e=!1)}))})();const o=createToolbar([],[a,n]);e.appendChild(o);const l=createElement("div",{style:{display:"flex",alignItems:"center",flexWrap:"wrap"}}),r=createElement("label",{style:{margin:"var(--margin-small)"}},"Token (Encryption Key): "),i=createElement("input",{type:"text",placeholder:"Enter token for encrypted save",style:{flex:"1",minWidth:"150px",marginRight:"var(--margin-small)"}}),s=createElement("button",{onclick:()=>c.click(),style:{marginRight:"var(--margin-small)"}},"Attach"),c=createElement("input",{type:"file",style:{display:"none"}});c.addEventListener("change",(async()=>{const e=c.files[0];if(e){const t=await readFileAsync(e);i.value=t.content.trim(),c.value=""}})),l.appendChild(r),l.appendChild(i),l.appendChild(s),l.appendChild(c),e.appendChild(l);const d=createElement("div",{style:{display:"flex",alignItems:"center",margin:"var(--margin-small)"}}),p=createElement("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"center"}});e.appendChild(d),d.appendChild(p);const h=createElement("input",{type:"checkbox",checked:isAutoSaveEnabled,onchange:e=>{isAutoSaveEnabled=e.target.checked,localStorage.setItem("autoSaveEnabled",isAutoSaveEnabled),isAutoSaveEnabled?(saveData(""),startAutoSave(),startCountdownDisplay(v)):(stopAutoSave(),stopCountdownDisplay(),v.textContent="Auto-save in: --s")}}),u=createElement("label",{style:{display:"flex",alignItems:"center"}},"Auto Save: ",h),m=createElement("input",{style:{margin:"var(--margin-small)"},type:"range",min:"1000",max:"60000",step:"1000",value:autoSaveInterval,oninput:e=>{autoSaveInterval=parseInt(e.target.value,10),localStorage.setItem("autoSaveInterval",autoSaveInterval),g.textContent=`Interval: ${autoSaveInterval/1e3}s`,isAutoSaveEnabled&&(lastSaveTimestamp=Date.now(),startAutoSave(),startCountdownDisplay(v))}}),g=createElement("span",{},`Interval: ${autoSaveInterval/1e3}s`),y=createElement("div",{style:{display:"flex",alignItems:"center"}},m,g);p.appendChild(u),p.appendChild(y);const f=createElement("div",{class:"info"}),b=createElement("div"),v=createElement("div",{class:"info"},"Auto-save in: --s"),w=()=>{const e={chatMessages:chatMessages,flashcards:flashcards,whiteboardData:window.whiteboardData,codeData:window.codeData,reminders:reminders},t=JSON.stringify(e),a=new Blob([t]).size,n=5242880,o=a/n*100;b.style.width=o+"%",f.textContent=`Memory used: ${(a/1048576).toFixed(2)} MB (${o.toFixed(1)}% of ${5..toFixed(2)} MB)`};f.appendChild(b),e.appendChild(f),e.appendChild(v);const E=createElement("div",{style:{marginTop:"var(--margin-small)"}}),x=createElement("h3",{},"Theme Customization"),C={Light:{"--color-background":"#ffffff","--color-primary":"#f0f0f0","--color-border":"#cccccc","--color-accent":"#0078d4","--color-accent-background":"#e6f2ff","--color-accent-background-hover":"#cce6ff","--color-text-light":"#000000","--color-text-muted":"#666666","--font-family":'"Segoe UI", Tahoma, Geneva, Verdana, sans-serif',"--font-family-code":"monospace","--font-size-base":"1em","--font-size-small":"0.8em","--border-radius-circle":"16px","--padding-small":"6px 12px","--margin-small":"5px","--gap-small":"10px"},Dark:{"--color-background":"#000000","--color-primary":"#12111b","--color-border":"#1e1e2f","--color-accent":"#ff5100","--color-accent-background":"#551b00","--color-accent-background-hover":"#351b00","--color-text-light":"#dcdcdc","--color-text-muted":"#696969","--font-family":'"Segoe UI", Tahoma, Geneva, Verdana, sans-serif',"--font-family-code":"monospace","--font-size-base":"1em","--font-size-small":"0.8em","--border-radius-circle":"16px","--padding-small":"6px 12px","--margin-small":"5px","--gap-small":"10px"}},k=createElement("select",{style:{marginBottom:"var(--margin-small)"},onchange:()=>{const e=C[k.value];e&&(Object.entries(e).forEach((([e,t])=>{if(document.documentElement.style.setProperty(e,t),D[e]&&(D[e].value=t),S.includes(e)){const a=D[e].nextElementSibling;a&&"color"===a.type&&(a.value=t)}})),localStorage.setItem("customTheme",JSON.stringify(e)))}},createElement("option",{value:""},"Choose Preset"),...Object.keys(C).map((e=>createElement("option",{value:e},e))));e.appendChild(k);const S=["--color-background","--color-primary","--color-border","--color-accent","--color-accent-background","--color-accent-background-hover","--color-text-light","--color-text-muted"],I=[...S,"--font-family","--font-family-code","--font-size-base","--font-size-small","--border-radius-circle","--padding-small","--margin-small","--gap-small"],D={};I.forEach((e=>{const t=getComputedStyle(document.documentElement).getPropertyValue(e).trim(),a=createElement("label",{style:{display:"flex",alignItems:"center",margin:"5px 0"}}),n=createElement("input",{type:"text",value:t,style:{flex:"1"},oninput:t=>{document.documentElement.style.setProperty(e,t.target.value),o&&(o.value=t.target.value)}});let o;S.includes(e)&&(o=createElement("input",{type:"color",value:t,style:{width:"32px",height:"32px",padding:"0",border:"none",background:"none",cursor:"pointer"},oninput:e=>{n.value=e.target.value,n.dispatchEvent(new Event("input"))}}));const l=createElement("span",{style:{width:"200px"}},(e=>e.replace(/^--/,"").replace(/-/g," ").replace(/\b\w/g,(e=>e.toUpperCase())))(e));a.appendChild(l),a.appendChild(n),o&&a.appendChild(o),D[e]=n,E.appendChild(a)}));const T=createElement("button",{onclick:()=>{const e={};I.forEach((t=>e[t]=D[t].value));const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(t);createElement("a",{href:a,download:"theme.json"}).click(),URL.revokeObjectURL(a)},style:{marginRight:"var(--margin-small)"}},"Export Theme"),L=createElement("input",{type:"file",style:{display:"none"}}),A=createElement("button",{onclick:()=>L.click()},"Import Theme");L.addEventListener("change",(async()=>{const e=L.files[0];if(e){const t=await readFileAsync(e);try{const e=JSON.parse(t.content);for(const[t,a]of Object.entries(e)){if(D[t]&&(D[t].value=a),S.includes(t)){const e=D[t].nextElementSibling;e&&"color"===e.type&&(e.value=a)}document.documentElement.style.setProperty(t,a)}}catch(e){alert("Invalid theme file.")}}})),E.appendChild(createElement("div",{style:{display:"flex"}},T,A,L));const M=createElement("button",{onclick:resetTheme},"Reset Theme"),R=createElement("div",{style:{display:"flex",alignItems:"center",flexWrap:"wrap",marginLeft:"auto"}},x,T,A,M,L);e.appendChild(R),e.appendChild(E);const P=localStorage.getItem("customTheme");if(P)try{const e=JSON.parse(P);Object.entries(e).forEach((([e,t])=>{document.documentElement.style.setProperty(e,t)}))}catch(e){}isAutoSaveEnabled&&startCountdownDisplay(v),w()},resetTheme=()=>{const e={"--color-background":"#000000","--color-primary":"#12111b","--color-border":"#1e1e2f","--color-accent":"#ff5100","--color-accent-background":"#551b00","--color-accent-background-hover":"#351b00","--color-text-light":"#dcdcdc","--color-text-muted":"#696969","--color-success-bg":"#34b60080","--color-error-bg":"#c0004a80","--font-family":'"Segoe UI", Tahoma, Geneva, Verdana, sans-serif',"--font-family-code":"monospace","--font-size-base":"1em","--font-size-small":"0.8em","--border-radius-circle":"16px","--padding-small":"6px 12px","--margin-small":"5px","--gap-small":"10px"};Object.entries(e).forEach((([e,t])=>{document.documentElement.style.setProperty(e,t),"undefined"!=typeof themeInputs&&themeInputs[e]&&(themeInputs[e].value=t)})),localStorage.setItem("customTheme",JSON.stringify(e))},loadSavedData=async()=>{const e=localStorage.getItem("appData"),t="true"===localStorage.getItem("isEncrypted");if(e)try{const a=JSON.parse(e);if(window.whiteboardData=a.whiteboardData||{},t)return void await showDecryptModal();{const e=a.data;Object.assign(chatMessages,e.chatMessages||{}),Object.assign(flashcards,e.flashcards||{}),window.codeData=e.codeData||{},Object.assign(reminders,e.reminders||{}),e.categories&&channelCategories.splice(0,channelCategories.length,...e.categories)}}catch(e){}isAutoSaveEnabled&&startAutoSave(),renderSidebar(),channelCategories.length&&channelCategories[0].channels.length&&selectChannel(channelCategories[0].channels[0])},showDecryptModal=async()=>{const e=localStorage.getItem("appData"),t="true"===localStorage.getItem("isEncrypted");if(!e||!t)return;const a=createElement("div",{style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"black",display:"flex",justifyContent:"center",alignItems:"center",zIndex:"1000"}}),n=createElement("div",{style:{padding:"var(--padding-small)",borderRadius:"var(--border-radius-circle)",border:"2px solid var(--color-primary)",display:"flex",flexDirection:"column",alignItems:"center",width:"90%",maxWidth:"400px",color:"var(--color-text-light)"}}),o=createElement("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"center",gap:"var(--margin-small)",width:"100%"}}),l=createElement("input",{type:"text",placeholder:"Enter encryption token"}),r=createElement("input",{type:"file",style:{display:"none"}}),i=createElement("button",{onclick:()=>r.click()},"Attach");r.addEventListener("change",(async()=>{const e=r.files[0];if(e){const t=await readFileAsync(e);l.value=t.content.trim(),s.disabled=!l.value.trim(),c.style.display="none",r.value=""}}));const s=createElement("button",{onclick:async()=>{const t=l.value.trim();if(!t)return c.style.display="block",void(c.textContent="Please enter a token.");try{const n=JSON.parse(e),o=await decryptText(n.data.encryptedText,t),l=JSON.parse(o);Object.assign(chatMessages,l.chatMessages||{}),Object.assign(flashcards,l.flashcards||{}),window.codeData=l.codeData||{},Object.assign(reminders,l.reminders||{}),l.categories&&channelCategories.splice(0,channelCategories.length,...l.categories),window.whiteboardData=n.whiteboardData||{},document.body.removeChild(a),renderSidebar(),channelCategories.length&&channelCategories[0].channels.length&&selectChannel(channelCategories[0].channels[0])}catch(e){c.style.display="block",c.textContent="Incorrect token. Please try again."}},disabled:!0},"Load Data");o.appendChild(l),o.appendChild(i),o.appendChild(r),o.appendChild(s);const c=createElement("div",{class:"info",style:{display:"none"}},"Incorrect token. Please try again."),d=createElement("button",{class:"button-aux",onclick:()=>{document.body.removeChild(a),renderSidebar(),channelCategories.length&&channelCategories[0].channels.length&&selectChannel(channelCategories[0].channels[0])}},"Skip");l.addEventListener("input",(()=>{s.disabled=!l.value.trim(),c.style.display="none"})),n.appendChild(o),n.appendChild(c),n.appendChild(d),a.appendChild(n),document.body.appendChild(a),l.focus()};document.addEventListener("DOMContentLoaded",(()=>{loadSavedData()}))})();